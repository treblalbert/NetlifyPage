<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧔 ASCII Dwarf Simulation - Albert Adroer Prats</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .floating-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: float 25s infinite linear;
        }

        .floating-circle:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 15%;
            left: 85%;
            animation-delay: 0s;
        }

        .floating-circle:nth-child(2) {
            width: 50px;
            height: 50px;
            top: 70%;
            right: 5%;
            animation-delay: -8s;
        }

        .floating-circle:nth-child(3) {
            width: 90px;
            height: 90px;
            top: 40%;
            left: 3%;
            animation-delay: -16s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-25px) rotate(120deg); }
            66% { transform: translateY(15px) rotate(240deg); }
        }

        .back-button, .source-btn {
            position: fixed;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .back-button {
            top: 20px;
            left: 20px;
        }

        .source-buttons {
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .back-button:hover, .source-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 80px 20px 20px;
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            min-height: calc(100vh - 100px);
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
        }

        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent
            );
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #fff 0%, #e1e5f2 50%, #fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .header em {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 14px;
        }

        input, select, button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        button {
            cursor: pointer;
            font-weight: 600;
            text-align: center;
        }

        button:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .map-container {
            flex: 1;
            min-height: 400px;
        }

        .map-display {
            width: 100%;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1;
            padding: 15px;
            border-radius: 15px;
            overflow: auto;
            white-space: pre;
            border: 1px solid rgba(255, 255, 255, 0.2);
            resize: none;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-display {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.9);
            white-space: pre-line;
        }

        .notifications {
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
        }

        .notification-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .legend {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            color: rgba(255, 255, 255, 0.9);
            white-space: pre;
        }

        .environment-info {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 15px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            margin: 3% auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            color: rgba(255, 255, 255, 0.7);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: white;
        }

        .code-container {
            padding: 30px;
            max-height: 75vh;
            overflow-y: auto;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .code-block pre {
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            margin: 0;
            white-space: pre;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 60px 15px 15px;
            }
            
            .source-buttons {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-bottom: 20px;
            }

            .back-button {
                position: relative;
                top: 0;
                left: 0;
                display: inline-block;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        /* Map colors */
        .water { color: #4a90a4; }
        .grass { color: #7ba428; }
        .mountain { color: #8b7355; }
        .gold { color: #cc9900; }
        .port { color: #8e6a5b; }
        .forest { color: #5d7c47; }
        .farm { color: #b8860b; }
        .ruins { color: #a0826d; }
        .grave { color: #666666; }
        .dwarf { color: #e67e22; background-color: rgba(52, 73, 94, 0.3); }
        .deer { color: #daa520; }
        .wolf { color: #cd5c5c; }
        .building { color: #9b59b6; }
        .corpse { color: #ff4444; }
    </style>
</head>
<body>
    <div class="floating-elements">
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
    </div>

    <a href="../" class="back-button">← Back to Portfolio</a>

    <div class="source-buttons">
        <button class="source-btn" onclick="showPythonCode()">🐍 Python Code</button>
        <button class="source-btn" onclick="showHTMLCode()">🌐 HTML Code</button>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="glass-panel">
                <div class="header">
                    <h1>🧔 ASCII Dwarf Simulation</h1>
                    <p>Watch dwarfs build a thriving civilization in ASCII art</p>
                    <p><em>Complex AI simulation originally developed in Python</em></p>
                </div>

                <div class="environment-info" id="environmentInfo">
                    🌸 Spring | ☀️ Sunny | Year 1, Day 1
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label>🗺️ Map Size</label>
                        <select id="mapSize">
                            <option value="small">Small (50x25)</option>
                            <option value="medium" selected>Medium (80x40)</option>
                            <option value="large">Large (120x60)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>🧔 Starting Dwarfs</label>
                        <input type="number" id="dwarfCount" value="15" min="5" max="50">
                    </div>
                    <div class="control-group">
                        <label>⚡ Simulation Speed</label>
                        <select id="simSpeed">
                            <option value="slow">Slow (2s)</option>
                            <option value="medium" selected>Medium (1s)</option>
                            <option value="fast">Fast (0.5s)</option>
                            <option value="turbo">Turbo (0.2s)</option>
                        </select>
                    </div>
                </div>

                <div class="controls">
                    <button id="generateBtn">🎲 Generate New World</button>
                    <button id="startBtn">▶️ Start Civilization</button>
                    <button id="pauseBtn" disabled>⏸️ Pause</button>
                    <button id="resetBtn">🔄 Reset World</button>
                </div>
            </div>

            <div class="glass-panel map-container">
                <h3>🗺️ Dwarf World</h3>
                <textarea class="map-display" id="mapDisplay" readonly 
                          placeholder="Generate a world to begin the simulation..."></textarea>
            </div>
        </div>

        <div class="right-panel">
            <div class="glass-panel">
                <h3>📊 Civilization Statistics</h3>
                <div class="stats-display" id="statsDisplay">
👥 Population: 0
💰 Total Wealth: 0
💖 Avg Health: 0/100
😊 Avg Happiness: 0/100
🏗️ Buildings: 0
⚔️ Battles: 0
                </div>
            </div>

            <div class="glass-panel">
                <h3>📢 World Events</h3>
                <div class="notifications" id="notifications">
                    <div class="notification-item">🌍 Welcome to the ASCII Dwarf Simulation!</div>
                    <div class="notification-item">🎮 Generate a world and start your civilization!</div>
                </div>
            </div>

            <div class="glass-panel">
                <h3>🗂️ Legend</h3>
                <div class="legend">🌊 ~ Water    🌱 . Grass    🏔️ ^ Mountain
💰 G Mine     🚢 P Port     🌲 T Forest  
🏛️ R Ruins    🌾 F Farm     ✝ ✝ Grave
🏠 H House    🍺 V Tavern   🔨 W Workshop
🧔 D Dwarf    ☠ ☠ Corpse   🦌 Deer 🐺 Wolf</div>
            </div>
        </div>
    </div>

    <!-- Python Code Modal -->
    <div id="pythonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🐍 Original Python Source Code</h2>
                <span class="close" onclick="closeModal('pythonModal')">&times;</span>
            </div>
            <div class="code-container">
                <div class="code-block">
                    <pre id="pythonCodeContent">Loading Python code...</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- HTML Code Modal -->
    <div id="htmlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🌐 HTML/JavaScript Source Code</h2>
                <span class="close" onclick="closeModal('htmlModal')">&times;</span>
            </div>
            <div class="code-container">
                <div class="code-block">
                    <pre id="htmlCodeContent">Loading HTML code...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DwarfSimulation {
            constructor() {
                this.map = null;
                this.dwarfs = [];
                this.animals = [];
                this.corpses = [];
                this.buildings = new Map();
                
                this.running = false;
                this.gameTime = 0;
                this.day = 1;
                this.year = 1;
                this.season = 'Spring';
                this.weather = 'Sunny';
                
                this.notifications = [];
                this.maxNotifications = 20;
                
                this.terrainTypes = {
                    WATER: '~',
                    GRASS: '.',
                    MOUNTAIN: '^',
                    GOLD_MINE: 'G',
                    PORT: 'P',
                    FOREST: 'T',
                    FARM: 'F',
                    RUINS: 'R',
                    GRAVE: '✝',
                    HOUSE: 'H',
                    TAVERN: 'V',
                    WORKSHOP: 'W'
                };
                
                this.dwarfNames = [
                    'Thorin', 'Balin', 'Dwalin', 'Gimli', 'Legolas', 'Groin', 'Fundin',
                    'Bjorn', 'Erik', 'Gunnar', 'Harald', 'Magnus', 'Olaf', 'Ragnar',
                    'Hamish', 'Duncan', 'Fergus', 'Ian', 'Malcolm', 'Wallace',
                    'Bruno', 'Conrad', 'Franz', 'Gustav', 'Karl', 'Ludwig',
                    'Ironbeard', 'Stoneaxe', 'Goldbeard', 'Steelhammer', 'Albert'
                ];
                
                this.initializeElements();
                this.bindEvents();
                this.addNotification("🌍 Welcome to Albert's ASCII Dwarf Simulation!");
                this.addNotification("🎮 Create a world and watch dwarfs build their civilization!");
            }
            
            initializeElements() {
                this.mapSizeSelect = document.getElementById('mapSize');
                this.dwarfCountInput = document.getElementById('dwarfCount');
                this.simSpeedSelect = document.getElementById('simSpeed');
                this.generateBtn = document.getElementById('generateBtn');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.mapDisplay = document.getElementById('mapDisplay');
                this.statsDisplay = document.getElementById('statsDisplay');
                this.notificationsDiv = document.getElementById('notifications');
                this.environmentInfo = document.getElementById('environmentInfo');
            }
            
            bindEvents() {
                this.generateBtn.addEventListener('click', () => this.generateWorld());
                this.startBtn.addEventListener('click', () => this.startSimulation());
                this.pauseBtn.addEventListener('click', () => this.pauseSimulation());
                this.resetBtn.addEventListener('click', () => this.resetSimulation());
            }
            
            generateWorld() {
                const mapSizes = {
                    small: [50, 25],
                    medium: [80, 40],
                    large: [120, 60]
                };
                
                const [width, height] = mapSizes[this.mapSizeSelect.value];
                this.map = this.createMap(width, height);
                this.dwarfs = [];
                this.animals = [];
                this.corpses = [];
                this.buildings.clear();
                
                this.generateAnimals();
                this.updateDisplay();
                this.addNotification(`🗺️ New ${width}x${height} world generated!`);
                this.addNotification("🧔 Ready to spawn dwarfs and begin civilization!");
            }
            
            createMap(width, height) {
                const map = Array(height).fill().map(() => Array(width).fill(this.terrainTypes.WATER));
                
                // Generate landmasses using simplified noise
                const numIslands = Math.floor(Math.random() * 3) + 2;
                const islandCenters = [];
                
                for (let i = 0; i < numIslands; i++) {
                    islandCenters.push({
                        x: Math.floor(Math.random() * width),
                        y: Math.floor(Math.random() * height),
                        radius: Math.floor(Math.random() * Math.min(width, height) / 4) + 10
                    });
                }
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        let minDistance = Infinity;
                        for (const island of islandCenters) {
                            const distance = Math.sqrt((x - island.x) ** 2 + (y - island.y) ** 2);
                            minDistance = Math.min(minDistance, distance / island.radius);
                        }
                        
                        const noise = this.simpleNoise(x * 0.1, y * 0.1) * 0.3;
                        const terrainValue = minDistance + noise;
                        
                        if (terrainValue < 0.8) {
                            if (terrainValue < 0.3 && Math.random() > 0.7) {
                                map[y][x] = this.terrainTypes.MOUNTAIN;
                            } else {
                                map[y][x] = this.terrainTypes.GRASS;
                            }
                        }
                    }
                }
                
                // Add special terrain
                this.addSpecialTerrain(map, width, height);
                
                return { terrain: map, width, height };
            }
            
            simpleNoise(x, y) {
                const n = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;
                return (n - Math.floor(n)) * 2 - 1;
            }
            
            addSpecialTerrain(map, width, height) {
                const grassTiles = [];
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        if (map[y][x] === this.terrainTypes.GRASS) {
                            grassTiles.push({ x, y });
                        }
                    }
                }
                
                // Add gold mines
                const numMines = Math.floor(grassTiles.length / 100) + 2;
                for (let i = 0; i < numMines && grassTiles.length > 0; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    map[y][x] = this.terrainTypes.GOLD_MINE;
                }
                
                // Add forests
                const numForests = Math.floor(grassTiles.length / 80);
                for (let i = 0; i < numForests && grassTiles.length > 0; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    map[y][x] = this.terrainTypes.FOREST;
                }
                
                // Add ports near water
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        if (map[y][x] === this.terrainTypes.GRASS && Math.random() < 0.02) {
                            let hasWaterNeighbor = false;
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    if (map[y + dy][x + dx] === this.terrainTypes.WATER) {
                                        hasWaterNeighbor = true;
                                        break;
                                    }
                                }
                                if (hasWaterNeighbor) break;
                            }
                            if (hasWaterNeighbor) {
                                map[y][x] = this.terrainTypes.PORT;
                            }
                        }
                    }
                }
                
                // Add ruins
                const numRuins = Math.floor(Math.random() * 5) + 2;
                for (let i = 0; i < numRuins && grassTiles.length > 0; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    map[y][x] = this.terrainTypes.RUINS;
                }
            }
            
            generateAnimals() {
                if (!this.map) return;
                
                const grassTiles = [];
                for (let y = 0; y < this.map.height; y++) {
                    for (let x = 0; x < this.map.width; x++) {
                        if (this.map.terrain[y][x] === this.terrainTypes.GRASS || 
                            this.map.terrain[y][x] === this.terrainTypes.FOREST) {
                            grassTiles.push({ x, y });
                        }
                    }
                }
                
                // Add deer
                const numDeer = Math.floor(grassTiles.length / 200) + 5;
                for (let i = 0; i < numDeer && grassTiles.length > 0; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    this.animals.push({
                        x, y, type: 'deer', health: 100, age: 0, alive: true
                    });
                }
                
                // Add wolves (fewer)
                const numWolves = Math.floor(grassTiles.length / 500) + 2;
                for (let i = 0; i < numWolves && grassTiles.length > 0; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    this.animals.push({
                        x, y, type: 'wolf', health: 150, age: 0, alive: true
                    });
                }
            }
            
            startSimulation() {
                if (!this.map) {
                    this.addNotification("❌ Generate a world first!");
                    return;
                }
                
                if (this.dwarfs.length === 0) {
                    this.generateDwarfs();
                }
                
                this.running = true;
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.generateBtn.disabled = true;
                
                this.addNotification("🎬 Civilization begins! Watch the dwarfs live their lives!");
                this.simulationLoop();
            }
            
            pauseSimulation() {
                this.running = false;
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.generateBtn.disabled = false;
                this.addNotification("⏸️ Simulation paused.");
            }
            
            resetSimulation() {
                this.running = false;
                this.gameTime = 0;
                this.day = 1;
                this.year = 1;
                this.season = 'Spring';
                this.weather = 'Sunny';
                this.dwarfs = [];
                this.animals = [];
                this.corpses = [];
                this.buildings.clear();
                this.notifications = [];
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.generateBtn.disabled = false;
                
                if (this.map) {
                    this.generateAnimals();
                    this.updateDisplay();
                }
                
                this.addNotification("🔄 World reset! Ready for a new civilization!");
                this.updateEnvironmentDisplay();
            }
            
            generateDwarfs() {
                const count = parseInt(this.dwarfCountInput.value);
                const grassTiles = [];
                
                for (let y = 0; y < this.map.height; y++) {
                    for (let x = 0; x < this.map.width; x++) {
                        if (this.map.terrain[y][x] === this.terrainTypes.GRASS) {
                            grassTiles.push({ x, y });
                        }
                    }
                }
                
                const actualCount = Math.min(count, grassTiles.length);
                
                for (let i = 0; i < actualCount; i++) {
                    const index = Math.floor(Math.random() * grassTiles.length);
                    const { x, y } = grassTiles.splice(index, 1)[0];
                    
                    let name = this.dwarfNames[Math.floor(Math.random() * this.dwarfNames.length)];
                    let nameCounter = 1;
                    const originalName = name;
                    
                    while (this.dwarfs.some(d => d.name === name)) {
                        name = `${originalName}${nameCounter}`;
                        nameCounter++;
                    }
                    
                    const dwarf = {
                        x, y,
                        name,
                        age: Math.floor(Math.random() * 30) + 18,
                        gender: Math.random() < 0.5 ? 'M' : 'F',
                        health: 100,
                        happiness: 100,
                        hunger: 80,
                        gold: Math.floor(Math.random() * 20),
                        alive: true,
                        state: 'wandering',
                        stateTimer: 0,
                        targetX: x,
                        targetY: y,
                        profession: 'Citizen',
                        skills: this.generateSkills(),
                        relationships: new Map(),
                        inventory: { food: 10, tools: 0, weapons: 0 },
                        kills: 0,
                        buildings: 0,
                        lifeEvents: []
                    };
                    
                    this.dwarfs.push(dwarf);
                }
                
                this.addNotification(`🧔 ${actualCount} brave dwarfs have founded the settlement!`);
            }
            
            generateSkills() {
                return {
                    mining: Math.floor(Math.random() * 20) + 1,
                    fishing: Math.floor(Math.random() * 20) + 1,
                    building: Math.floor(Math.random() * 20) + 1,
                    farming: Math.floor(Math.random() * 20) + 1,
                    hunting: Math.floor(Math.random() * 20) + 1,
                    combat: Math.floor(Math.random() * 20) + 1,
                    trading: Math.floor(Math.random() * 20) + 1
                };
            }
            
            simulationLoop() {
                if (!this.running) return;
                
                this.gameTime++;
                
                // Update environment every 50 ticks
                if (this.gameTime % 50 === 0) {
                    this.updateEnvironment();
                }
                
                // Age population every 500 ticks
                if (this.gameTime % 500 === 0) {
                    this.agePopulation();
                }
                
                this.updateDwarfs();
                this.updateAnimals();
                this.updateDisplay();
                this.updateStats();
                
                const speeds = { slow: 2000, medium: 1000, fast: 500, turbo: 200 };
                const delay = speeds[this.simSpeedSelect.value] || 1000;
                
                setTimeout(() => this.simulationLoop(), delay);
            }
            
            updateEnvironment() {
                this.day++;
                
                if (this.day % 30 === 0) {
                    const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
                    const currentIndex = seasons.indexOf(this.season);
                    this.season = seasons[(currentIndex + 1) % seasons.length];
                    
                    if (this.season === 'Spring') {
                        this.year++;
                    }
                    
                    this.addNotification(`🌍 ${this.season} has arrived! Year ${this.year}`);
                }
                
                if (Math.random() < 0.3) {
                    const weathers = ['Sunny', 'Rainy', 'Stormy', 'Foggy'];
                    this.weather = weathers[Math.floor(Math.random() * weathers.length)];
                }
                
                this.updateEnvironmentDisplay();
            }
            
            updateEnvironmentDisplay() {
                const seasonEmojis = { Spring: '🌸', Summer: '☀️', Autumn: '🍂', Winter: '❄️' };
                const weatherEmojis = { Sunny: '☀️', Rainy: '🌧️', Stormy: '⛈️', Foggy: '🌫️' };
                
                this.environmentInfo.textContent = 
                    `${seasonEmojis[this.season]} ${this.season} | ${weatherEmojis[this.weather]} ${this.weather} | Year ${this.year}, Day ${this.day}`;
            }
            
            agePopulation() {
                let deaths = 0;
                
                this.dwarfs.forEach(dwarf => {
                    if (!dwarf.alive) return;
                    
                    dwarf.age++;
                    
                    if (dwarf.age > 70 && Math.random() < 0.01) {
                        dwarf.health -= Math.floor(Math.random() * 10);
                    }
                    
                    if (dwarf.age > 90 && Math.random() < 0.02) {
                        dwarf.alive = false;
                        dwarf.health = 0;
                        deaths++;
                        this.corpses.push({
                            x: dwarf.x,
                            y: dwarf.y,
                            name: dwarf.name,
                            age: dwarf.age,
                            timeSinceDeath: 0
                        });
                    }
                });
                
                if (deaths > 0) {
                    this.addNotification(`📊 ${deaths} dwarfs died of old age this year`);
                }
            }
            
            updateDwarfs() {
                this.dwarfs.forEach(dwarf => {
                    if (!dwarf.alive) return;
                    
                    dwarf.stateTimer = Math.max(0, dwarf.stateTimer - 1);
                    dwarf.hunger = Math.max(0, dwarf.hunger - 0.1);
                    dwarf.happiness = Math.max(0, dwarf.happiness - 0.05);
                    
                    if (dwarf.hunger < 20) {
                        dwarf.health = Math.max(0, dwarf.health - 0.2);
                    }
                    
                    // Auto-eat food when hungry
                    if (dwarf.hunger < 50 && dwarf.inventory.food > 0) {
                        dwarf.inventory.food--;
                        dwarf.hunger = Math.min(100, dwarf.hunger + 20);
                        dwarf.health = Math.min(100, dwarf.health + 5);
                    }
                    
                    this.updateDwarfState(dwarf);
                    this.moveDwarf(dwarf);
                    this.checkDwarfInteractions(dwarf);
                });
            }
            
            updateDwarfState(dwarf) {
                if (dwarf.state === 'mining' && dwarf.stateTimer <= 0) {
                    const goldMined = Math.floor(Math.random() * 5) + 1;
                    dwarf.gold += goldMined;
                    dwarf.skills.mining++;
                    dwarf.state = 'resting';
                    dwarf.stateTimer = 20;
                    this.setRandomTarget(dwarf);
                    this.addNotification(`⛏️ ${dwarf.name} mined ${goldMined} gold!`);
                    
                } else if (dwarf.state === 'fishing' && dwarf.stateTimer <= 0) {
                    const foodCaught = Math.floor(Math.random() * 5) + 2;
                    const goldEarned = Math.floor(Math.random() * 3) + 1;
                    dwarf.inventory.food += foodCaught;
                    dwarf.gold += goldEarned;
                    dwarf.skills.fishing++;
                    dwarf.state = 'resting';
                    dwarf.stateTimer = 15;
                    this.setRandomTarget(dwarf);
                    this.addNotification(`🎣 ${dwarf.name} caught ${foodCaught} food!`);
                    
                } else if (dwarf.state === 'building' && dwarf.stateTimer <= 0) {
                    if (this.tryBuildStructure(dwarf)) {
                        dwarf.skills.building++;
                        dwarf.buildings++;
                    }
                    dwarf.state = 'resting';
                    dwarf.stateTimer = 30;
                    this.setRandomTarget(dwarf);
                    
                } else if (dwarf.state === 'resting' && dwarf.stateTimer <= 0) {
                    dwarf.health = Math.min(100, dwarf.health + 3);
                    dwarf.happiness = Math.min(100, dwarf.happiness + 2);
                    dwarf.state = 'wandering';
                    this.setRandomTarget(dwarf);
                    
                } else if (dwarf.state === 'fighting' && dwarf.stateTimer <= 0) {
                    dwarf.state = 'wandering';
                    this.setRandomTarget(dwarf);
                }
            }
            
            moveDwarf(dwarf) {
                if (dwarf.state !== 'wandering') return;
                
                const dx = Math.sign(dwarf.targetX - dwarf.x);
                const dy = Math.sign(dwarf.targetY - dwarf.y);
                
                const newX = dwarf.x + (Math.random() < 0.7 ? dx : 0);
                const newY = dwarf.y + (Math.random() < 0.7 ? dy : 0);
                
                if (this.isWalkable(newX, newY) && !this.isDwarfAt(newX, newY)) {
                    dwarf.x = newX;
                    dwarf.y = newY;
                }
                
                if (dwarf.x === dwarf.targetX && dwarf.y === dwarf.targetY) {
                    this.setRandomTarget(dwarf);
                }
            }
            
            setRandomTarget(dwarf) {
                dwarf.targetX = Math.max(0, Math.min(this.map.width - 1, 
                    dwarf.x + Math.floor(Math.random() * 21) - 10));
                dwarf.targetY = Math.max(0, Math.min(this.map.height - 1, 
                    dwarf.y + Math.floor(Math.random() * 21) - 10));
            }
            
            isWalkable(x, y) {
                if (x < 0 || x >= this.map.width || y < 0 || y >= this.map.height) return false;
                
                const terrain = this.map.terrain[y][x];
                return terrain !== this.terrainTypes.WATER && terrain !== this.terrainTypes.MOUNTAIN;
            }
            
            isDwarfAt(x, y) {
                return this.dwarfs.some(d => d.alive && d.x === x && d.y === y);
            }
            
            checkDwarfInteractions(dwarf) {
                if (dwarf.state !== 'wandering') return;
                
                const terrain = this.map.terrain[dwarf.y][dwarf.x];
                
                // Terrain-based activities
                if (terrain === this.terrainTypes.GOLD_MINE && Math.random() < 0.3) {
                    dwarf.state = 'mining';
                    dwarf.stateTimer = 8;
                    return;
                }
                
                if (terrain === this.terrainTypes.PORT && Math.random() < 0.3) {
                    dwarf.state = 'fishing';
                    dwarf.stateTimer = 6;
                    return;
                }
                
                if (terrain === this.terrainTypes.GRASS && Math.random() < 0.1) {
                    dwarf.state = 'building';
                    dwarf.stateTimer = 12;
                    return;
                }
                
                // Check for other dwarfs nearby
                const nearbyDwarfs = this.dwarfs.filter(other => 
                    other !== dwarf && other.alive &&
                    Math.abs(other.x - dwarf.x) <= 1 && Math.abs(other.y - dwarf.y) <= 1
                );
                
                if (nearbyDwarfs.length > 0) {
                    const other = nearbyDwarfs[Math.floor(Math.random() * nearbyDwarfs.length)];
                    this.handleDwarfInteraction(dwarf, other);
                }
            }
            
            handleDwarfInteraction(dwarf1, dwarf2) {
                const action = Math.random();
                
                if (action < 0.1) {
                    this.dwarfFight(dwarf1, dwarf2);
                } else if (action < 0.3) {
                    this.dwarfTrade(dwarf1, dwarf2);
                } else if (action < 0.5) {
                    this.dwarfSocialize(dwarf1, dwarf2);
                } else if (action < 0.6 && dwarf1.gender !== dwarf2.gender) {
                    this.dwarfReproduce(dwarf1, dwarf2);
                }
            }
            
            dwarfFight(dwarf1, dwarf2) {
                dwarf1.state = 'fighting';
                dwarf2.state = 'fighting';
                dwarf1.stateTimer = 5;
                dwarf2.stateTimer = 5;
                
                const power1 = dwarf1.health + dwarf1.skills.combat * 2;
                const power2 = dwarf2.health + dwarf2.skills.combat * 2;
                
                const winner = power1 > power2 ? dwarf1 : dwarf2;
                const loser = power1 > power2 ? dwarf2 : dwarf1;
                
                const goldStolen = Math.min(loser.gold, Math.floor(Math.random() * 5) + 1);
                winner.gold += goldStolen;
                loser.gold -= goldStolen;
                
                const damage = Math.floor(Math.random() * 15) + 10;
                loser.health -= damage;
                winner.health -= Math.floor(Math.random() * 8) + 2;
                
                winner.skills.combat++;
                loser.skills.combat++;
                
                if (loser.health <= 0) {
                    loser.alive = false;
                    winner.kills++;
                    this.corpses.push({
                        x: loser.x, y: loser.y, name: loser.name, age: loser.age, timeSinceDeath: 0
                    });
                    this.addNotification(`⚔️ ${winner.name} killed ${loser.name} in combat!`);
                } else {
                    this.addNotification(`⚔️ ${winner.name} defeated ${loser.name} and stole ${goldStolen} gold!`);
                }
            }
            
            dwarfTrade(dwarf1, dwarf2) {
                if (dwarf1.inventory.food > dwarf2.inventory.food && dwarf2.gold > dwarf1.gold) {
                    const foodTraded = Math.min(2, dwarf1.inventory.food);
                    const goldTraded = Math.min(3, dwarf2.gold);
                    
                    dwarf1.inventory.food -= foodTraded;
                    dwarf1.gold += goldTraded;
                    dwarf2.inventory.food += foodTraded;
                    dwarf2.gold -= goldTraded;
                    
                    this.addNotification(`💼 ${dwarf1.name} traded ${foodTraded} food for ${goldTraded} gold with ${dwarf2.name}!`);
                }
            }
            
            dwarfSocialize(dwarf1, dwarf2) {
                dwarf1.happiness = Math.min(100, dwarf1.happiness + 5);
                dwarf2.happiness = Math.min(100, dwarf2.happiness + 5);
                
                if (Math.random() < 0.1) {
                    this.addNotification(`🤝 ${dwarf1.name} and ${dwarf2.name} became friends!`);
                }
            }
            
            dwarfReproduce(dwarf1, dwarf2) {
                // Find empty spot near parents
                for (let dx = -2; dx <= 2; dx++) {
                    for (let dy = -2; dy <= 2; dy++) {
                        const x = dwarf1.x + dx;
                        const y = dwarf1.y + dy;
                        
                        if (this.isWalkable(x, y) && !this.isDwarfAt(x, y)) {
                            const parentName = Math.random() < 0.5 ? dwarf1.name : dwarf2.name;
                            let childName = `${parentName}Jr`;
                            let counter = 1;
                            
                            while (this.dwarfs.some(d => d.name === childName)) {
                                childName = `${parentName}Jr${counter}`;
                                counter++;
                            }
                            
                            const child = {
                                x, y, name: childName,
                                age: 0,
                                gender: Math.random() < 0.5 ? 'M' : 'F',
                                health: 100, happiness: 100, hunger: 80,
                                gold: 0, alive: true,
                                state: 'wandering', stateTimer: 0,
                                targetX: x, targetY: y,
                                profession: 'Citizen',
                                skills: this.generateSkills(),
                                relationships: new Map(),
                                inventory: { food: 5, tools: 0, weapons: 0 },
                                kills: 0, buildings: 0, lifeEvents: []
                            };
                            
                            this.dwarfs.push(child);
                            this.addNotification(`👶 ${childName} was born to ${dwarf1.name} and ${dwarf2.name}!`);
                            return;
                        }
                    }
                }
            }
            
            tryBuildStructure(dwarf) {
                const buildingTypes = [this.terrainTypes.HOUSE, this.terrainTypes.TAVERN, this.terrainTypes.WORKSHOP];
                const buildingType = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                
                // Try to build near current position
                for (let dx = -2; dx <= 2; dx++) {
                    for (let dy = -2; dy <= 2; dy++) {
                        const x = dwarf.x + dx;
                        const y = dwarf.y + dy;
                        
                        if (x >= 0 && x < this.map.width && y >= 0 && y < this.map.height &&
                            this.map.terrain[y][x] === this.terrainTypes.GRASS && 
                            !this.buildings.has(`${x},${y}`)) {
                            
                            this.buildings.set(`${x},${y}`, buildingType);
                            
                            const buildingNames = {
                                [this.terrainTypes.HOUSE]: 'house',
                                [this.terrainTypes.TAVERN]: 'tavern',
                                [this.terrainTypes.WORKSHOP]: 'workshop'
                            };
                            
                            this.addNotification(`🏗️ ${dwarf.name} built a ${buildingNames[buildingType]}!`);
                            return true;
                        }
                    }
                }
                return false;
            }
            
            updateAnimals() {
                this.animals.forEach(animal => {
                    if (!animal.alive) return;
                    
                    animal.age++;
                    
                    // Animals move randomly
                    if (Math.random() < 0.3) {
                        const newX = animal.x + Math.floor(Math.random() * 3) - 1;
                        const newY = animal.y + Math.floor(Math.random() * 3) - 1;
                        
                        if (this.isWalkable(newX, newY)) {
                            animal.x = newX;
                            animal.y = newY;
                        }
                    }
                    
                    // Animals die of old age
                    if (animal.age > 200 && Math.random() < 0.01) {
                        animal.alive = false;
                    }
                });
            }
            
            updateDisplay() {
                if (!this.map) return;
                
                const display = Array(this.map.height).fill().map(() => Array(this.map.width).fill(' '));
                
                // Draw terrain
                for (let y = 0; y < this.map.height; y++) {
                    for (let x = 0; x < this.map.width; x++) {
                        display[y][x] = this.map.terrain[y][x];
                    }
                }
                
                // Draw buildings
                this.buildings.forEach((buildingType, key) => {
                    const [x, y] = key.split(',').map(Number);
                    if (x >= 0 && x < this.map.width && y >= 0 && y < this.map.height) {
                        display[y][x] = buildingType;
                    }
                });
                
                // Draw animals
                this.animals.forEach(animal => {
                    if (animal.alive && animal.x >= 0 && animal.x < this.map.width && 
                        animal.y >= 0 && animal.y < this.map.height) {
                        display[animal.y][animal.x] = animal.type === 'deer' ? 'D' : 'W';
                    }
                });
                
                // Draw corpses
                this.corpses.forEach(corpse => {
                    if (corpse.x >= 0 && corpse.x < this.map.width && 
                        corpse.y >= 0 && corpse.y < this.map.height) {
                        display[corpse.y][corpse.x] = '☠';
                    }
                });
                
                // Draw dwarfs (they override everything else)
                this.dwarfs.forEach(dwarf => {
                    if (dwarf.alive && dwarf.x >= 0 && dwarf.x < this.map.width && 
                        dwarf.y >= 0 && dwarf.y < this.map.height) {
                        display[dwarf.y][dwarf.x] = 'D';
                    }
                });
                
                const mapString = display.map(row => row.join('')).join('\n');
                this.mapDisplay.value = mapString;
            }
            
            updateStats() {
                const aliveDwarfs = this.dwarfs.filter(d => d.alive);
                const totalGold = aliveDwarfs.reduce((sum, d) => sum + d.gold, 0);
                const avgHealth = aliveDwarfs.length > 0 ? 
                    aliveDwarfs.reduce((sum, d) => sum + d.health, 0) / aliveDwarfs.length : 0;
                const avgHappiness = aliveDwarfs.length > 0 ? 
                    aliveDwarfs.reduce((sum, d) => sum + d.happiness, 0) / aliveDwarfs.length : 0;
                
                const males = aliveDwarfs.filter(d => d.gender === 'M').length;
                const females = aliveDwarfs.filter(d => d.gender === 'F').length;
                
                const totalKills = aliveDwarfs.reduce((sum, d) => sum + d.kills, 0);
                const totalBuildings = this.buildings.size;
                
                const aliveAnimals = this.animals.filter(a => a.alive);
                const deer = aliveAnimals.filter(a => a.type === 'deer').length;
                const wolves = aliveAnimals.filter(a => a.type === 'wolf').length;
                
                this.statsDisplay.textContent = `👥 Population: ${aliveDwarfs.length} (♂️${males} | ♀️${females})
💰 Total Wealth: ${totalGold}
💖 Avg Health: ${avgHealth.toFixed(1)}/100
😊 Avg Happiness: ${avgHappiness.toFixed(1)}/100
🏗️ Buildings: ${totalBuildings}
⚔️ Total Battles: ${totalKills}
🌍 Wildlife: 🦌${deer} | 🐺${wolves}
☠ Corpses: ${this.corpses.length}
⏰ Game Time: ${this.gameTime} ticks`;
            }
            
            addNotification(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.notifications.unshift(`[${timestamp}] ${message}`);
                
                if (this.notifications.length > this.maxNotifications) {
                    this.notifications = this.notifications.slice(0, this.maxNotifications);
                }
                
                this.updateNotificationDisplay();
            }
            
            updateNotificationDisplay() {
                this.notificationsDiv.innerHTML = this.notifications
                    .map(notification => `<div class="notification-item">${notification}</div>`)
                    .join('');
            }
        }

        // Source code data
        const pythonCode = `import tkinter as tk
from tkinter import ttk, simpledialog, messagebox
import random
import math
from enum import Enum
from typing import Dict, List, Optional
import time
import datetime

class TerrainType(Enum):
    WATER = '~'
    GRASS = '.'
    MOUNTAIN = '^'
    GOLD_MINE = 'G'
    PORT = 'P'
    FOREST = 'T'
    FARM = 'F'
    RUINS = 'R'
    GRAVE = '✝'

class BuildingType(Enum):
    HOUSE = 'H'
    TAVERN = 'V'
    WORKSHOP = 'W'
    BARRACKS = 'B'
    TEMPLE = 'L'
    MARKET = 'M'
    SCHOOL = 'S'
    WALL = '#'
    ROAD = '+'

class DwarfState(Enum):
    WANDERING = "🚶 Wandering"
    MINING = "⛏️ Mining"
    FISHING = "🎣 Fishing"
    BUILDING = "🔨 Building"
    FARMING = "🌾 Farming"
    HUNTING = "🏹 Hunting"
    CRAFTING = "🔧 Crafting"
    TRADING = "💼 Trading"
    RESEARCHING = "📚 Researching"
    RESTING = "😴 Resting"
    FIGHTING = "⚔️ Fighting"
    SOCIALIZING = "💬 Socializing"
    EXPLORING = "🗺️ Exploring"
    PRAYING = "🙏 Praying"
    TEACHING = "👨‍🏫 Teaching"
    RETIRING = "🧓 Retiring"
    BURYING = "⚰️ Burying"
    MOURNING = "😢 Mourning"

class Profession(Enum):
    NONE = "Citizen"
    MINER = "Miner"
    FISHER = "Fisher"
    FARMER = "Farmer"
    HUNTER = "Hunter"
    BUILDER = "Builder"
    CRAFTER = "Crafter"
    TRADER = "Trader"
    SCHOLAR = "Scholar"
    SOLDIER = "Soldier"
    PRIEST = "Priest"
    TEACHER = "Teacher"
    LEADER = "Leader"
    EXPLORER = "Explorer"

class Relationship(Enum):
    NEUTRAL = 0
    FRIEND = 1
    ENEMY = -1
    FAMILY = 2
    LOVER = 3

class Season(Enum):
    SPRING = "🌸 Spring"
    SUMMER = "☀️ Summer"
    AUTUMN = "🍂 Autumn"
    WINTER = "❄️ Winter"

class Weather(Enum):
    SUNNY = "☀️ Sunny"
    RAINY = "🌧️ Rainy"
    STORMY = "⛈️ Stormy"
    SNOWY = "❄️ Snowy"
    FOGGY = "🌫️ Foggy"

class Animal:
    def __init__(self, x, y, animal_type):
        self.x = x
        self.y = y
        self.type = animal_type  # 'deer', 'wolf', 'fish'
        self.health = 100
        self.age = 0
        self.alive = True

class HistoryEvent:
    def __init__(self, day, season, year, event_type, description, participants=None):
        self.day = day
        self.season = season
        self.year = year
        self.event_type = event_type  # 'birth', 'death', 'combat', 'construction', 'discovery', etc.
        self.description = description
        self.participants = participants or []
        self.game_time = 0

class EventType(Enum):
    BIRTH = "👶 Birth"
    DEATH = "💀 Death"
    COMBAT = "⚔️ Combat"
    CONSTRUCTION = "🏗️ Construction"
    DISCOVERY = "🔍 Discovery"
    RELATIONSHIP = "💕 Relationship"
    ACHIEVEMENT = "🏆 Achievement"
    ECONOMY = "💰 Economy"
    EXPLORATION = "🗺️ Exploration"
    DISASTER = "🌪️ Disaster"
    CEREMONY = "🎉 Ceremony"
    MILESTONE = "📊 Milestone"

class Corpse:
    def __init__(self, dwarf, x, y):
        self.dwarf_name = dwarf.name
        self.x = x
        self.y = y
        self.age_at_death = dwarf.age
        self.cause_of_death = "Unknown"
        self.time_since_death = 0
        self.buried = False
        self.buried_by = None
        self.grave_message = f"Here lies {dwarf.name}, aged {dwarf.age}"

class Technology:
    def __init__(self, name, description, requirements, cost):
        self.name = name
        self.description = description
        self.requirements = requirements
        self.cost = cost
        self.researched = False

class Settlement:
    def __init__(self, name, x, y):
        self.name = name
        self.x = x
        self.y = y
        self.population = 0
        self.buildings = []
        self.leader = None
        self.faction = None

class Dwarf:
    def __init__(self, x, y, name):
        self.x = x
        self.y = y
        self.name = name
        self.age = random.randint(18, 30)
        self.gender = random.choice(['M', 'F'])
        self.gold = 0
        self.health = 100
        self.hunger = 100
        self.happiness = 100
        self.profession = Profession.NONE
        self.state = DwarfState.WANDERING
        self.state_timer = 0
        self.mining_cooldown = 0
        self.fishing_cooldown = 0
        self.skills = self.generate_initial_skills()
        self.relationships: Dict[str, Relationship] = {}
        self.target_x = x
        self.target_y = y
        self.alive = True
        self.next_x = x
        self.next_y = y
        self.home = None
        self.settlement = None
        self.faction = None
        self.inventory = {'food': 15, 'tools': 0, 'weapons': 0, 'materials': 0}  # FIXED: Increased from 5 to 15
        self.spouse = None
        self.children = []
        self.parents = []
        self.life_story = []  # Track major life events
        self.kills = 0
        self.times_mined = 0
        self.times_fished = 0
        self.buildings_built = 0
        self.total_gold_earned = 0
        self.burials_performed = 0
        self.grief_level = 0  # How sad the dwarf is from losing friends/family
        self.cause_of_death = ""
        
        # Add birth story
        self.add_life_event(f"Born at age {self.age} as a {self.get_gender_name()}")
        
    def generate_initial_skills(self):
        """Generate skills with gender influence"""
        base_skills = {
            'mining': random.randint(1, 10),
            'fishing': random.randint(1, 10),
            'building': random.randint(1, 10),
            'farming': random.randint(1, 10),
            'hunting': random.randint(1, 10),
            'crafting': random.randint(1, 10),
            'trading': random.randint(1, 10),
            'combat': random.randint(1, 10),
            'research': random.randint(1, 10)
        }
        
        # Gender influences (slight bonuses, not restrictions)
        if self.gender == 'M':
            base_skills['mining'] += random.randint(0, 3)
            base_skills['combat'] += random.randint(0, 3)
            base_skills['building'] += random.randint(0, 2)
        else:  # Female
            base_skills['crafting'] += random.randint(0, 3)
            base_skills['trading'] += random.randint(0, 3)
            base_skills['research'] += random.randint(0, 2)
            base_skills['farming'] += random.randint(0, 2)
        
        return base_skills
    
    def get_gender_name(self):
        return "Male" if self.gender == 'M' else "Female"
    
    def add_life_event(self, event):
        """Add an event to the dwarf's life story"""
        self.life_story.append(f"Age {self.age}: {event}")
        if len(self.life_story) > 50:  # Keep only last 50 events
            self.life_story = self.life_story[-50:]
        
    def get_power(self):
        base_power = self.health + (self.gold * 5) + (self.skills['combat'] * 3)
        # Males get slight combat bonus, females get diplomatic bonus
        if self.gender == 'M':
            base_power += 5
        else:
            base_power += self.happiness // 10  # Happiness affects female combat effectiveness
        return base_power
    
    def age_dwarf(self):
        self.age += 1
        # FIXED: More realistic aging - only affects very old dwarfs
        if self.age > 70:  # Changed from 60 to 70
            self.health -= random.randint(0, 1)  # Reduced aging damage, can be 0
        if self.age > 90 and random.random() < 0.02:  # Changed from 80 and 0.05 to 90 and 0.02
            self.health = 0  # Ensure death by setting health to 0
        
        # Check for death due to health
        if self.health <= 0:
            self.alive = False
            self.health = 0  # Ensure it's exactly 0
    
    def gain_skill(self, skill, amount=1):
        if skill in self.skills:
            old_level = self.skills[skill]
            self.skills[skill] = min(100, self.skills[skill] + amount)
            new_level = self.skills[skill]
            
            # Add life events for skill milestones
            for milestone in [25, 50, 75, 100]:
                if old_level < milestone <= new_level:
                    self.add_life_event(f"Reached {skill} skill level {milestone}")
                    if milestone == 100:
                        self.add_life_event(f"Mastered the art of {skill}!")
    
    def move_towards_target(self):
        new_x, new_y = self.x, self.y
        
        if self.x < self.target_x:
            new_x = self.x + 1
        elif self.x > self.target_x:
            new_x = self.x - 1
            
        if self.y < self.target_y:
            new_y = self.y + 1
        elif self.y > self.target_y:
            new_y = self.y - 1
        
        self.next_x = new_x
        self.next_y = new_y
    
    def set_random_target(self, map_width, map_height):
        attempts = 0
        while attempts < 20:
            self.target_x = random.randint(max(0, self.x - 20), min(map_width - 1, self.x + 20))
            self.target_y = random.randint(max(0, self.y - 20), min(map_height - 1, self.y + 20))
            attempts += 1

# ... [Continue with Map, DwarfSimulation classes and all other methods - over 2000 lines total]

class DwarfSimulation:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("🧔 Albert's ASCII Dwarfs Simulation ⛏️")
        self.root.state('zoomed')
        self.root.configure(bg='#f5f2e8')  # Warm cream background
        
        # Configure style
        self.setup_styles()
        
        # Initialize zoom level
        self.zoom_level = 1.0
        self.min_zoom = 0.3
        self.max_zoom = 3.0
        
        # Initialize variables
        self.map_width_var = tk.StringVar(value="300")
        self.map_height_var = tk.StringVar(value="100")
        self.dwarf_count_var = tk.StringVar(value="20")
        
        self.dwarfs: List[Dwarf] = []
        self.animals: List[Animal] = []
        self.corpses: List[Corpse] = []  # Track unburied corpses
        self.settlements: List[Settlement] = []
        self.technologies: List[Technology] = []
        self.running = False
        self.notifications = []
        self.max_notifications = 15
        
        # Time and environment
        self.game_time = 0
        self.day = 1
        self.year = 1
        self.season = Season.SPRING
        self.weather = Weather.SUNNY
        self.temperature = 20
        
        # Research and global stats
        self.global_research_points = 0
        self.total_population = 0
        self.total_gold = 0
        
        # Historical tracking system
        self.history: List[HistoryEvent] = []
        self.civilization_name = "New Dwarven Realm"
        self.last_recorded_population = 0
        
        # Expanded dwarf names - 150 total!
        self.dwarf_names = [
            # Original LOTR dwarfs
            "Thorin", "Balin", "Dwalin", "Fili", "Kili", "Dori", "Nori", "Ori",
            "Oin", "Gloin", "Bifur", "Bofur", "Bombur", "Gimli", "Legolas",
            "Groin", "Fundin", "Thrain", "Durin", "Borin", "Floi", "Frerin",
            "Gror", "Telchar", "Azog", "Bolg", "Dain", "Thror", "Nar", "Nali",
            
            # Traditional dwarf names
            "Alviss", "Andvari", "Berling", "Brokkr", "Dolgthrasir", "Eikinskjaldi",
            "Fafnir", "Gandalf", "Harbard", "Jari", "Kvasir", "Lit", "Motul",
            "Nyr", "Onar", "Radsvid", "Skirfir", "Thekk", "Ulf", "Vigg",
            
            # Nordic-inspired names
            "Bjorn", "Erik", "Gunnar", "Harald", "Ivar", "Jorgen", "Klaus", "Lars",
            "Magnus", "Nils", "Olaf", "Per", "Ragnar", "Sven", "Torbjorn", "Ulf",
            "Viggo", "Willem", "Xerxes", "Yngvar", "Zephyr", "Arne", "Baldur", "Cnut",
            
            # Scottish/Celtic-inspired
            "Hamish", "Duncan", "Fergus", "Gregor", "Hamish", "Ian", "Jock", "Kenneth",
            "Lachlan", "Malcolm", "Niall", "Oran", "Paddy", "Quinn", "Rory", "Stuart",
            "Tavish", "Uisdean", "Wallace", "Ximenes", "Yann", "Zander", "Ailean", "Brodie",
            
            # German/Austrian-inspired
            "Albrecht", "Bruno", "Conrad", "Dieter", "Ernst", "Franz", "Gustav", "Heinrich",
            "Johann", "Karl", "Ludwig", "Maximilian", "Norbert", "Otto", "Paul", "Rainer",
            "Stefan", "Theodor", "Ulrich", "Viktor", "Wolfgang", "Xaver", "Yannick", "Zacharias",
            
            # Fantasy dwarf names
            "Ironbeard", "Stoneaxe", "Goldbeard", "Steelhammer", "Rockbreaker", "Coalburner",
            "Ironforge", "Stoneheart", "Goldstrike", "Steelwall", "Rockface", "Coalbeard",
            "Ironback", "Stonefoot", "Goldtooth", "Steelbeard", "Rockhammer", "Coalfist",
            
            # More unique fantasy names
            "Draven", "Korgan", "Thorgrim", "Kazador", "Belegar", "Gotrek", "Felix", "Bardin",
            "Okri", "Ungrim", "Alrik", "Thane", "Runesmith", "Longbeard", "Slayer", "Engineer",
            "Ranger", "Warrior", "Priest", "King", "Lord", "Master", "Elder", "Ancient",
            
            # Female dwarf names
            "Disa", "Vera", "Mira", "Tova", "Inga", "Helga", "Astrid", "Sigrid",
            "Brunhilde", "Gudrun", "Freydis", "Solveig", "Ragnhild", "Thora", "Valdis", "Ylva",

            # Creators name!
            "Albert"
        ]
        
        self.setup_ui()
        self.setup_map_colors()
        self.setup_technologies()
        
        # Create initial map
        self.map = Map(300, 100)
        self.generate_initial_animals()
        self.update_display()
        self.add_notification("🌍 Welcome to Albert's ASCII Dwarfs Simulation!")
        self.add_notification("🔍 Use zoom controls or Ctrl+Mouse Wheel to zoom in/out!")
        self.add_notification("📏 Resize the window - everything adapts automatically!")
        self.add_notification("⌨️ Shortcuts: Ctrl +/- (zoom), Ctrl+0 (fit), F11 (fullscreen)")
        self.add_notification("🎮 Experience the ultimate ASCII dwarf civilization!")
        
        # Record civilization founding
        self.record_history(EventType.MILESTONE, f"The {self.civilization_name} was founded!", [])

# ... [The complete implementation continues with all methods, over 2000+ lines total]
# This includes complex AI behaviors, relationship systems, combat mechanics,
# world generation algorithms, historical tracking, and comprehensive UI

if __name__ == "__main__":
    simulation = DwarfSimulation()
    simulation.run()`;

        const htmlCode = document.documentElement.outerHTML;

        // Modal functions
        function showPythonCode() {
            document.getElementById('pythonCodeContent').textContent = pythonCode;
            document.getElementById('pythonModal').style.display = 'block';
        }

        function showHTMLCode() {
            document.getElementById('htmlCodeContent').textContent = htmlCode;
            document.getElementById('htmlModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const pythonModal = document.getElementById('pythonModal');
            const htmlModal = document.getElementById('htmlModal');
            if (event.target == pythonModal) {
                pythonModal.style.display = 'none';
            }
            if (event.target == htmlModal) {
                htmlModal.style.display = 'none';
            }
        }

        // Initialize the simulation when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DwarfSimulation();
        });
    </script>
</body>
</html>