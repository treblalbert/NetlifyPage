<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Galaxy - Leave Your Mark</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: white;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            cursor: grab;
        }

        body:active {
            cursor: grabbing;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #star-counter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        #search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        #search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 8px;
            color: white;
            width: 200px;
        }

        #search-input::placeholder {
            color: #aaa;
        }

        #search-results {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
            margin: 2px 0;
        }

        .search-result:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            max-width: 250px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        /* Modal Styles */
        #welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #333;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #4da6ff;
            text-shadow: 0 0 10px rgba(77, 166, 255, 0.5);
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #555;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .modal-content input::placeholder {
            color: #aaa;
        }

        .modal-content button {
            background: linear-gradient(45deg, #4da6ff, #0073e6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .modal-content button:hover {
            transform: scale(1.05);
        }

        .modal-content button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #fff;
            margin: 10px auto;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="ui-overlay">
        <div id="instructions">
            <h3>üåü Star Galaxy</h3>
            <p><strong>Controls:</strong></p>
            <p>‚Ä¢ Drag: Rotate view</p>
            <p>‚Ä¢ Scroll: Zoom in/out</p>
            <p>‚Ä¢ Click stars to focus</p>
            <p>‚Ä¢ Space: Reset to center</p>
            <p><br><em>Welcome to the galaxy! Your star has been added to this cosmic collection.</em></p>
        </div>

        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search stars by name...">
            <div id="search-results"></div>
        </div>

        <div id="star-counter">
            <h3>‚≠ê Galaxy Stats</h3>
            <p>Total Stars: <span id="star-count">0</span></p>
            <p>Unique Visitors: <span id="visitor-count">0</span></p>
        </div>

        <div id="star-details">
            <h3>üåü Star Details</h3>
            <div id="star-info-content">
                <p><em>Click on a star to see its details</em></p>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal">
        <div class="modal-content">
            <h2>üåü Welcome to the Star Galaxy!</h2>
            <p>Leave your mark in the cosmos by creating your own star.</p>
            
            <input type="text" id="user-name" placeholder="Enter your name" maxlength="20">
            
            <div>
                <label for="star-color">Choose your star color:</label>
                <input type="color" id="star-color" value="#ffffff">
                <div id="color-preview" style="background-color: #ffffff;"></div>
            </div>
            
            <button id="create-star" onclick="createUserStar()">Create My Star ‚ú®</button>
        </div>
    </div>

    <script>
        // Galaxy data storage (in real implementation, this would be in a database)
        let galaxyData = {
            stars: [],
            visitors: new Set(),
            visitCount: 0
        };

        // Three.js setup
        let scene, camera, renderer, controls;
        let starMeshes = [];
        let selectedStar = null;

        // Camera control variables
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let cameraDistance = 50;
        let cameraRotation = { x: 0, y: 0 };
        let focusTarget = new THREE.Vector3(0, 0, 0);
        const rotationSpeed = 0.005;

        // Initialize the 3D scene
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x000020, 1, 1000);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, cameraDistance);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000011);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Add some background stars
            createBackgroundStars();

            // Load existing stars (in real app, this would load from server)
            loadExistingStars();

            // Event listeners
            setupEventListeners();

            // Animation loop
            animate();
        }

        function createBackgroundStars() {
            const bgStarGeometry = new THREE.BufferGeometry();
            const bgStarCount = 1000;
            const positions = new Float32Array(bgStarCount * 3);

            for (let i = 0; i < bgStarCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 2000;
                positions[i + 1] = (Math.random() - 0.5) * 2000;
                positions[i + 2] = (Math.random() - 0.5) * 2000;
            }

            bgStarGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const bgStarMaterial = new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 0.5,
                transparent: true,
                opacity: 0.6
            });

            const bgStars = new THREE.Points(bgStarGeometry, bgStarMaterial);
            scene.add(bgStars);
        }

        function loadExistingStars() {
            // Simulate some existing stars (in real app, load from database)
            const existingStars = [
                { name: "Alice", color: "#ff6b6b", position: { x: 10, y: 5, z: -10 } },
                { name: "Bob", color: "#4ecdc4", position: { x: -15, y: -8, z: 5 } },
                { name: "Charlie", color: "#45b7d1", position: { x: 8, y: -12, z: -5 } },
                { name: "Diana", color: "#f9ca24", position: { x: -10, y: 10, z: 8 } },
                { name: "Explorer", color: "#6c5ce7", position: { x: 0, y: 0, z: 0 } }
            ];

            existingStars.forEach(star => {
                galaxyData.stars.push(star);
                createStarMesh(star);
            });

            galaxyData.visitCount = existingStars.length;
            updateCounters();
        }

        function createUserStar() {
            const name = document.getElementById('user-name').value.trim();
            const color = document.getElementById('star-color').value;

            if (!name) {
                alert('Please enter your name!');
                return;
            }

            // Check if user already exists (simplified - in real app, check by IP)
            const existingStar = galaxyData.stars.find(star => star.name.toLowerCase() === name.toLowerCase());
            if (existingStar) {
                alert('A star with this name already exists! Please choose a different name.');
                return;
            }

            // Create star data
            const starData = {
                name: name,
                color: color,
                position: generateStarPosition(),
                timestamp: new Date().toISOString()
            };

            // Add to galaxy
            galaxyData.stars.push(starData);
            galaxyData.visitCount++;

            // Create 3D star
            createStarMesh(starData);

            // Update UI
            updateCounters();
            
            // Hide modal
            document.getElementById('welcome-modal').classList.add('hidden');

            // Focus on the new star
            focusOnStar(starData);
        }

        function generateStarPosition() {
            // Generate position in a roughly spherical distribution
            const radius = Math.random() * 40 + 10;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.random() * Math.PI;

            return {
                x: radius * Math.sin(phi) * Math.cos(theta),
                y: radius * Math.sin(phi) * Math.sin(theta),
                z: radius * Math.cos(phi)
            };
        }

        function createStarMesh(starData) {
            // Create main star (white core)
            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                transparent: true,
                opacity: 1
            });

            const star = new THREE.Mesh(geometry, material);
            star.position.set(starData.position.x, starData.position.y, starData.position.z);
            star.userData = starData;

            // Create multiple glow layers for better effect
            const glowLayers = [];
            
            // Inner glow
            const innerGlowGeometry = new THREE.SphereGeometry(1.2, 12, 12);
            const innerGlowMaterial = new THREE.MeshBasicMaterial({
                color: starData.color,
                transparent: true,
                opacity: 0.6
            });
            const innerGlow = new THREE.Mesh(innerGlowGeometry, innerGlowMaterial);
            innerGlow.position.copy(star.position);
            glowLayers.push(innerGlow);
            
            // Outer glow
            const outerGlowGeometry = new THREE.SphereGeometry(2, 8, 8);
            const outerGlowMaterial = new THREE.MeshBasicMaterial({
                color: starData.color,
                transparent: true,
                opacity: 0.3
            });
            const outerGlow = new THREE.Mesh(outerGlowGeometry, outerGlowMaterial);
            outerGlow.position.copy(star.position);
            glowLayers.push(outerGlow);
            
            // Distant glow
            const distantGlowGeometry = new THREE.SphereGeometry(3.5, 6, 6);
            const distantGlowMaterial = new THREE.MeshBasicMaterial({
                color: starData.color,
                transparent: true,
                opacity: 0.1
            });
            const distantGlow = new THREE.Mesh(distantGlowGeometry, distantGlowMaterial);
            distantGlow.position.copy(star.position);
            glowLayers.push(distantGlow);
            
            scene.add(star);
            glowLayers.forEach(glow => scene.add(glow));
            starMeshes.push({ star, glowLayers, data: starData });
        }

        function focusOnStar(starData) {
            // Set new focus target
            const targetFocus = new THREE.Vector3(
                starData.position.x,
                starData.position.y,
                starData.position.z
            );
            
            // Animate focus target transition
            animateFocusTo(targetFocus);
        }

        function animateFocusTo(targetFocus) {
            const startFocus = focusTarget.clone();
            const startTime = Date.now();
            const duration = 2000; // 2 seconds

            function updateFocus() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easing = 1 - Math.pow(1 - progress, 3); // Ease out cubic

                focusTarget.lerpVectors(startFocus, targetFocus, easing);

                if (progress < 1) {
                    requestAnimationFrame(updateFocus);
                }
            }

            updateFocus();
        }

        function setupEventListeners() {
            // Mouse drag controls
            let hasMouseMoved = false;
            
            document.addEventListener('mousedown', (event) => {
                if (event.target.closest('#ui-overlay')) return; // Don't drag when clicking UI
                isDragging = true;
                hasMouseMoved = false;
                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
                document.body.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (event) => {
                if (!isDragging) return;
                
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;
                
                if (Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2) {
                    hasMouseMoved = true;
                }
                
                cameraRotation.y -= deltaX * rotationSpeed;
                cameraRotation.x -= deltaY * rotationSpeed;
                
                // Limit vertical rotation
                cameraRotation.x = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, cameraRotation.x));
                
                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
            });

            document.addEventListener('mouseup', (event) => {
                if (isDragging && !hasMouseMoved) {
                    // This was a click, not a drag
                    onStarClick(event);
                }
                isDragging = false;
                hasMouseMoved = false;
                document.body.style.cursor = 'grab';
            });

            // Mouse wheel for zoom
            document.addEventListener('wheel', (event) => {
                cameraDistance += event.deltaY * 0.1;
                cameraDistance = Math.max(5, Math.min(200, cameraDistance));
            });

            // Search functionality
            document.getElementById('search-input').addEventListener('input', onSearch);

            // Color preview update
            document.getElementById('star-color').addEventListener('input', (e) => {
                document.getElementById('color-preview').style.backgroundColor = e.target.value;
            });

            // Window resize
            window.addEventListener('resize', onWindowResize);

            // Enter key for star creation
            document.getElementById('user-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createUserStar();
            });

            // Reset focus to center with Space key
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    animateFocusTo(new THREE.Vector3(0, 0, 0));
                }
            });
        }

        function onStarClick(event) {
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const starObjects = starMeshes.map(s => s.star);
            const intersects = raycaster.intersectObjects(starObjects);

            if (intersects.length > 0) {
                const starData = intersects[0].object.userData;
                showStarInfo(starData);
                focusOnStar(starData);
            }
        }

        function showStarInfo(starData) {
            alert(`‚≠ê Star Owner: ${starData.name}\nüé® Color: ${starData.color}\nüìÖ Created: ${starData.timestamp ? new Date(starData.timestamp).toLocaleString() : 'Unknown'}`);
        }

        function onSearch(event) {
            const query = event.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            const matches = galaxyData.stars.filter(star => 
                star.name.toLowerCase().includes(query)
            );

            resultsContainer.innerHTML = matches.map(star => 
                `<div class="search-result" onclick="focusOnStarByName('${star.name}')" style="color: ${star.color}">
                    ‚≠ê ${star.name}
                </div>`
            ).join('');
        }

        function focusOnStarByName(name) {
            const star = galaxyData.stars.find(s => s.name === name);
            if (star) {
                focusOnStar(star);
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
            }
        }

        function updateCounters() {
            document.getElementById('star-count').textContent = galaxyData.stars.length;
            document.getElementById('visitor-count').textContent = galaxyData.visitCount;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update camera position based on rotation around focus target
            camera.position.x = focusTarget.x + cameraDistance * Math.sin(cameraRotation.y) * Math.cos(cameraRotation.x);
            camera.position.y = focusTarget.y + cameraDistance * Math.sin(cameraRotation.x);
            camera.position.z = focusTarget.z + cameraDistance * Math.cos(cameraRotation.y) * Math.cos(cameraRotation.x);
            
            camera.lookAt(focusTarget);

            // Animate star effects
            starMeshes.forEach((starObj, index) => {
                const time = Date.now() * 0.001;
                
                // Animate glow layers
                starObj.glowLayers.forEach((glow, layerIndex) => {
                    glow.material.opacity = (0.6 - layerIndex * 0.25) + Math.sin(time + index) * 0.1;
                    glow.rotation.y += 0.002 * (layerIndex + 1);
                    glow.rotation.x += 0.001 * (layerIndex + 1);
                });
                
                // Rotate main star
                starObj.star.rotation.y += 0.01;
                starObj.star.rotation.x += 0.005;
            });

            renderer.render(scene, camera);
        }

        // Start the application
        init();

        // Simulate user detection (in real app, this would be done server-side with IP checking)
        window.addEventListener('load', () => {
            // For demo purposes, always show the modal
            // In a real implementation, you'd check if the user's IP has visited before
            setTimeout(() => {
                document.getElementById('welcome-modal').style.display = 'flex';
            }, 500);
        });
    </script>
</body>
</html>