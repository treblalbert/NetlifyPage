<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness AI - Your Personal Trainer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #ff6b35;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 900;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            color: #ccc;
        }

        .app-section {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid #444;
            display: none;
        }

        .app-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #ff6b35;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #333;
            color: #fff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            margin-left: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #333;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #444;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #ff6b35;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            accent-color: #ff6b35;
        }

        .checkbox-item label {
            color: #fff !important;
            margin: 0 !important;
            text-transform: none !important;
            font-weight: 500 !important;
            font-size: 1rem !important;
            letter-spacing: normal !important;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .equipment-card {
            border: 2px solid #444;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(145deg, #333, #2a2a2a);
        }

        .equipment-card:hover {
            border-color: #ff6b35;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.2);
        }

        .equipment-card.selected {
            border-color: #ff6b35;
            background: linear-gradient(145deg, #ff6b35, #f7931e);
            color: #fff;
        }

        .equipment-card h4 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ff6b35;
        }

        .equipment-card.selected h4 {
            color: #fff;
        }

        .custom-equipment {
            margin-top: 15px;
            display: none;
        }

        .custom-equipment.active {
            display: block;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .goal-card {
            border: 2px solid #444;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(145deg, #333, #2a2a2a);
        }

        .goal-card:hover {
            border-color: #ff6b35;
            transform: translateY(-3px);
        }

        .goal-card.selected {
            border-color: #ff6b35;
            background: linear-gradient(145deg, #ff6b35, #f7931e);
            color: #fff;
        }

        .workout-plan {
            margin-top: 20px;
        }

        .day-section {
            background: linear-gradient(145deg, #333, #2a2a2a);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .day-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .exercise-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .exercise-table th,
        .exercise-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .exercise-table th {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .exercise-table td {
            color: #ccc;
        }

        .exercise-name {
            color: #ff6b35;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }

        .exercise-name:hover {
            color: #f7931e;
        }

        .chat-container {
            border: 2px solid #444;
            border-radius: 12px;
            height: 400px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #1f1f1f;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.user {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            margin-left: auto;
        }

        .message.bot {
            background: #333;
            border: 1px solid #444;
            color: #ccc;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
            background: #1a1a1a;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            resize: none;
            background: #333;
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #ff6b35;
        }

        .error {
            background: #d32f2f;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success {
            background: #388e3c;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .navigation {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }

        .nav-btn {
            background: transparent;
            color: #ff6b35;
            border: 2px solid #ff6b35;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            transform: translateY(-2px);
        }

        h2 {
            color: #ff6b35;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        h3 {
            color: #ff6b35;
            font-weight: 700;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .app-section {
                padding: 20px;
            }
            
            .equipment-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                margin: 5px;
                padding: 8px 15px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💪 FITNESS AI</h1>
            <p>Your AI-powered personal trainer</p>
        </div>

        <!-- Navigation -->
        <div class="navigation" id="navigation" style="display: none;">
            <button class="nav-btn active" onclick="showSection('profile')">Profile</button>
            <button class="nav-btn" onclick="showSection('preferences')">Preferences</button>
            <button class="nav-btn" onclick="showSection('workout')">Workout Plan</button>
            <button class="nav-btn" onclick="showSection('chat')">Chat with Flexi</button>
            <button class="nav-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Login/Register Section -->
        <div class="app-section active" id="auth-section">
            <h2>Welcome to Fitness AI</h2>
            <p>Enter your email to get started</p>
            
            <div id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email">
                </div>
                
                <button class="btn" onclick="loginWithEmail()">Continue</button>
            </div>
            
            <div id="message-area"></div>
        </div>

        <!-- Profile Section -->
        <div class="app-section" id="profile-section">
            <h2>Your Profile</h2>
            <div class="form-group">
                <label for="userName">Name</label>
                <input type="text" id="userName" placeholder="Enter your name">
            </div>
            
            <div class="form-group">
                <label for="userJob">Job Type</label>
                <select id="userJob">
                    <option value="">Select your job type</option>
                    <option value="sedentary">Sedentary (desk job)</option>
                    <option value="standing">Standing (retail, teaching)</option>
                    <option value="active">Physically Active (construction, delivery)</option>
                    <option value="very_active">Very Active (fitness trainer, athlete)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="userHeight">Height (cm)</label>
                <input type="number" id="userHeight" placeholder="170">
            </div>
            
            <div class="form-group">
                <label for="userWeight">Weight (kg)</label>
                <input type="number" id="userWeight" placeholder="70">
            </div>
            
            <div class="form-group">
                <label for="userCondition">Current Physical Condition (optional)</label>
                <textarea id="userCondition" rows="3" placeholder="Describe your current fitness level, any injuries, or limitations..."></textarea>
            </div>
            
            <button class="btn" onclick="saveProfile()">Save Profile</button>
        </div>

        <!-- Preferences Section -->
        <div class="app-section" id="preferences-section">
            <h2>Fitness Goals & Preferences</h2>
            
            <div class="form-group">
                <label>Fitness Goals (Select all that apply)</label>
                <div class="goals-grid">
                    <div class="goal-card" data-goal="lose_weight">
                        <h4>🔥 Lose Weight</h4>
                        <p>Burn fat and shed pounds</p>
                    </div>
                    <div class="goal-card" data-goal="gain_muscle">
                        <h4>💪 Gain Muscle</h4>
                        <p>Build strength and size</p>
                    </div>
                    <div class="goal-card" data-goal="improve_agility">
                        <h4>🤸 Improve Agility</h4>
                        <p>Enhance flexibility & mobility</p>
                    </div>
                    <div class="goal-card" data-goal="build_endurance">
                        <h4>🏃 Build Endurance</h4>
                        <p>Increase stamina & cardio</p>
                    </div>
                    <div class="goal-card" data-goal="general_health">
                        <h4>❤️ General Health</h4>
                        <p>Overall wellness & fitness</p>
                    </div>
                    <div class="goal-card" data-goal="sports_performance">
                        <h4>⚽ Sports Performance</h4>
                        <p>Athletic enhancement</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Training Days</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="monday" value="monday">
                        <label for="monday">Monday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="tuesday" value="tuesday">
                        <label for="tuesday">Tuesday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wednesday" value="wednesday">
                        <label for="wednesday">Wednesday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="thursday" value="thursday">
                        <label for="thursday">Thursday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="friday" value="friday">
                        <label for="friday">Friday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="saturday" value="saturday">
                        <label for="saturday">Saturday</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="sunday" value="sunday">
                        <label for="sunday">Sunday</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="sessionTime">Available Time per Session (minutes)</label>
                <select id="sessionTime">
                    <option value="">Select session duration</option>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">60 minutes</option>
                    <option value="90">90 minutes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Available Equipment</label>
                <div class="equipment-grid">
                    <div class="equipment-card" data-equipment="bodyweight">
                        <h4>💪 Bodyweight Only</h4>
                        <p>No equipment needed</p>
                    </div>
                    <div class="equipment-card" data-equipment="full_gym">
                        <h4>🏟️ Full Gym Access</h4>
                        <p>Complete gym equipment</p>
                    </div>
                    <div class="equipment-card" data-equipment="custom">
                        <h4>🔧 Custom Equipment</h4>
                        <p>I have specific equipment</p>
                    </div>
                </div>
                
                <div class="custom-equipment" id="customEquipment">
                    <label for="customEquipmentText">Describe your available equipment</label>
                    <textarea id="customEquipmentText" rows="3" placeholder="e.g., dumbbells up to 50kg, resistance bands, yoga mat, pull-up bar..."></textarea>
                </div>
            </div>
            
            <button class="btn" onclick="savePreferences()">Save Preferences & Continue</button>
        </div>

        <!-- Workout Plan Section -->
        <div class="app-section" id="workout-section">
            <h2>Your AI-Generated Workout Plan</h2>
            <p>Click on any exercise name to watch a tutorial on YouTube!</p>
            
            <button class="btn" onclick="generateWorkoutPlan()" id="generateBtn">Generate New Workout Plan</button>
            
            <div id="workoutPlan" class="workout-plan"></div>
        </div>

        <!-- Chat Section -->
        <div class="app-section" id="chat-section">
            <h2>Chat with Flexi 🤖</h2>
            <p>Your AI fitness assistant is here to help adapt your workouts and answer questions!</p>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <strong>Flexi:</strong> Hello! I'm Flexi, your AI fitness assistant. How can I help you today? You can ask me to modify your workout, report missed sessions, or get advice about your fitness journey!
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" placeholder="Type your message here..." rows="2"></textarea>
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabase;
        let currentUser = null;
        let userProfile = null;
        let userPreferences = null;
        let currentWorkoutPlan = null;

        // Initialize Supabase
        function initSupabase() {
            // Your actual Supabase credentials
            const supabaseUrl = 'https://yiqbppgelferacpuqfpx.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpcWJwcGdlbGZlcmFjcHVxZnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzY4MjgsImV4cCI6MjA2NjAxMjgyOH0.2ll0GZcQCNf_cXqcTqx--CardTx61BUqu-rUzPClbKc';
            
            // Check if Supabase is loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded. Check your internet connection and CDN.');
                showMessage('Failed to load required libraries. Please refresh the page.', 'error');
                return false;
            }
            
            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('✅ Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                showMessage('Failed to connect to database. Please check your configuration.', 'error');
                return false;
            }
        }

        // Initialize app with proper loading sequence
        function initializeApp() {
            if (initSupabase()) {
                setupEventListeners();
                checkAuthState();
            } else {
                // Retry after a short delay
                setTimeout(() => {
                    console.log('Retrying Supabase initialization...');
                    initializeApp();
                }, 1000);
            }
        }

        // Wait for both DOM and scripts to load
        document.addEventListener('DOMContentLoaded', function() {
            // Give scripts time to load
            setTimeout(initializeApp, 500);
        });

        function setupEventListeners() {
            // Equipment selection
            document.querySelectorAll('.equipment-card').forEach(card => {
                card.addEventListener('click', () => {
                    // Remove selection from other equipment cards
                    document.querySelectorAll('.equipment-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    // Show/hide custom equipment textarea
                    const customEquipment = document.getElementById('customEquipment');
                    if (card.dataset.equipment === 'custom') {
                        customEquipment.classList.add('active');
                    } else {
                        customEquipment.classList.remove('active');
                    }
                });
            });

            // Goal selection (multiple selection allowed)
            document.querySelectorAll('.goal-card').forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('selected');
                });
            });

            // Chat input
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Email input - allow Enter to submit
            document.getElementById('email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginWithEmail();
                }
            });
        }

        // Authentication functions - Simplified Email Only
        async function loginWithEmail() {
            const email = document.getElementById('email').value.trim();
            
            if (!email || !email.includes('@')) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }

            try {
                // Create a mock user object for email-only authentication
                currentUser = {
                    id: btoa(email).replace(/[^a-zA-Z0-9]/g, ''), // Simple ID from email
                    email: email,
                    created_at: new Date().toISOString()
                };
                
                // Store in localStorage for session persistence
                localStorage.setItem('fitness_ai_user', JSON.stringify(currentUser));
                
                showMessage('Welcome! Loading your profile...', 'success');
                
                // Load user data and show app
                await loadUserData();
                showApp();
                
            } catch (error) {
                console.error('Login failed:', error);
                showMessage(`Login failed: ${error.message}`, 'error');
            }
        }

        async function logout() {
            // Clear localStorage and reset state
            localStorage.removeItem('fitness_ai_user');
            currentUser = null;
            userProfile = null;
            userPreferences = null;
            currentWorkoutPlan = null;
            
            // Reset form
            document.getElementById('email').value = '';
            
            // Show auth section
            showSection('auth-section');
            document.getElementById('navigation').style.display = 'none';
        }

        async function checkAuthState() {
            // Check if user is stored in localStorage
            const storedUser = localStorage.getItem('fitness_ai_user');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    await loadUserData();
                    showApp();
                } catch (error) {
                    console.error('Error loading stored user:', error);
                    localStorage.removeItem('fitness_ai_user');
                }
            }
        }

        // Data management functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load user profile using email as identifier
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('email', currentUser.email)
                    .single();
                
                if (profile) {
                    userProfile = profile;
                    populateProfileForm();
                }

                // Load user preferences
                const { data: preferences } = await supabase
                    .from('user_preferences')
                    .select('*')
                    .eq('email', currentUser.email)
                    .single();
                
                if (preferences) {
                    userPreferences = preferences;
                    populatePreferencesForm();
                }

                // Load workout plan
                const { data: workoutPlan } = await supabase
                    .from('workout_plans')
                    .select('*')
                    .eq('email', currentUser.email)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (workoutPlan) {
                    currentWorkoutPlan = workoutPlan;
                    displayWorkoutPlan(workoutPlan.plan_data);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                // This is normal for new users - no existing data yet
            }
        }

        async function saveProfile() {
            if (!currentUser) return;

            const profileData = {
                email: currentUser.email,
                name: document.getElementById('userName').value,
                job_type: document.getElementById('userJob').value,
                height: parseInt(document.getElementById('userHeight').value),
                weight: parseInt(document.getElementById('userWeight').value),
                physical_condition: document.getElementById('userCondition').value,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert(profileData, { onConflict: 'email' });

                if (error) throw error;
                
                userProfile = profileData;
                showMessage('Profile saved successfully!', 'success');
                
                // Auto-advance to preferences
                setTimeout(() => {
                    showSection('preferences');
                }, 1500);
            } catch (error) {
                showMessage('Error saving profile: ' + error.message, 'error');
            }
        }

        async function savePreferences() {
            if (!currentUser) return;

            const trainingDays = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                trainingDays.push(cb.value);
            });

            const selectedGoals = [];
            document.querySelectorAll('.goal-card.selected').forEach(card => {
                selectedGoals.push(card.dataset.goal);
            });

            const selectedEquipment = [];
            const selectedEquipmentCard = document.querySelector('.equipment-card.selected');
            if (selectedEquipmentCard) {
                selectedEquipment.push(selectedEquipmentCard.dataset.equipment);
            }

            let customEquipmentText = '';
            if (selectedEquipmentCard && selectedEquipmentCard.dataset.equipment === 'custom') {
                customEquipmentText = document.getElementById('customEquipmentText').value;
            }

            const preferencesData = {
                email: currentUser.email,
                fitness_goals: selectedGoals,
                training_days: trainingDays,
                session_time: parseInt(document.getElementById('sessionTime').value),
                available_equipment: selectedEquipment,
                custom_equipment: customEquipmentText,
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('user_preferences')
                    .upsert(preferencesData, { onConflict: 'email' });

                if (error) throw error;
                
                userPreferences = preferencesData;
                showMessage('Preferences saved successfully!', 'success');
                
                // Auto-advance to workout plan
                setTimeout(() => {
                    showSection('workout');
                }, 1500);
            } catch (error) {
                showMessage('Error saving preferences: ' + error.message, 'error');
            }
        }

        // Workout plan generation
        async function generateWorkoutPlan() {
            if (!userProfile || !userPreferences) {
                showMessage('Please complete your profile and preferences first', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                const prompt = createWorkoutPrompt();
                const workoutPlan = await callOpenAI(prompt);
                
                // Save to database
                const { error } = await supabase
                    .from('workout_plans')
                    .insert({
                        email: currentUser.email,
                        plan_data: workoutPlan,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                currentWorkoutPlan = { plan_data: workoutPlan };
                displayWorkoutPlan(workoutPlan);
                
            } catch (error) {
                console.error('Error generating workout plan:', error);
                showMessage('Error generating workout plan: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate New Workout Plan';
            }
        }

        function createWorkoutPrompt() {
            const equipmentDescription = userPreferences.available_equipment[0] === 'custom' 
                ? userPreferences.custom_equipment 
                : userPreferences.available_equipment.join(', ');

            return `Create a personalized weekly workout plan based on the following user information:

Name: ${userProfile.name}
Job: ${userProfile.job_type}
Height: ${userProfile.height}cm
Weight: ${userProfile.weight}kg
Physical Condition: ${userProfile.physical_condition || 'Not specified'}
Fitness Goals: ${userPreferences.fitness_goals.join(', ')}
Training Days: ${userPreferences.training_days.join(', ')}
Session Time: ${userPreferences.session_time} minutes
Available Equipment: ${equipmentDescription}

Please create a detailed weekly workout plan that includes:
1. Specific exercises for each training day
2. Sets, reps, and rest times
3. Exercise order and progression
4. Consider the user's multiple goals, available time, and equipment

Format the response as a JSON object with this structure:
{
  "plan_overview": "Brief description of the plan",
  "weekly_schedule": {
    "monday": {
      "exercises": [
        {
          "name": "Exercise Name",
          "sets": 3,
          "reps": "12-15",
          "rest": "60 seconds",
          "notes": "Any specific instructions"
        }
      ]
    }
  }
}

Only include the days specified in the training days. Make sure exercises are appropriate for the available equipment and fitness goals.`;
        }

        async function callOpenAI(prompt) {
    console.log('Generating personalized workout plan...');
    
    // Use the enhanced local workout generator instead of API
    try {
        showMessage('Creating your personalized workout plan...', 'success');
        
        // Add a realistic delay to simulate processing
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        return generateFallbackWorkoutPlan();
        
    } catch (error) {
        console.error('Error generating workout:', error);
        showMessage('Error creating workout plan. Please check your profile and preferences.', 'error');
        throw error;
    }
}

function generateFallbackWorkoutPlan() {
    if (!userPreferences || !userProfile) {
        throw new Error('Please complete your profile and preferences first');
    }
    
    const trainingDays = userPreferences.training_days || ['monday', 'wednesday', 'friday'];
    const sessionTime = userPreferences.session_time || 45;
    const equipment = userPreferences.available_equipment?.[0] || 'bodyweight';
    const goals = userPreferences.fitness_goals || ['general_health'];
    const jobType = userProfile.job_type || 'sedentary';
    const weight = userProfile.weight || 70;
    const height = userProfile.height || 170;
    const name = userProfile.name || 'there';
    
    // Calculate BMI for better workout customization
    const bmi = weight / ((height / 100) ** 2);
    const isOverweight = bmi > 25;
    const isUnderweight = bmi < 18.5;
    
    // Create personalized plan overview
    let planDescription = `Hi ${name}! This is your personalized ${sessionTime}-minute workout plan using ${equipment === 'bodyweight' ? 'bodyweight exercises' : equipment === 'full_gym' ? 'full gym equipment' : 'your custom equipment'}. `;
    
    if (goals.length > 1) {
        planDescription += `This plan targets ${goals.slice(0, -1).join(', ').replace(/_/g, ' ')} and ${goals[goals.length - 1].replace(/_/g, ' ')}. `;
    } else {
        planDescription += `This plan focuses on ${goals[0].replace(/_/g, ' ')}. `;
    }
    
    if (jobType === 'sedentary') {
        planDescription += "I've included extra mobility work to counteract the effects of desk work. ";
    } else if (jobType === 'very_active') {
        planDescription += "This plan complements your active lifestyle with recovery-focused exercises. ";
    }
    
    planDescription += `Training ${trainingDays.length} days per week will help you reach your goals efficiently!`;
    
    const workoutPlan = {
        plan_overview: planDescription,
        weekly_schedule: {}
    };
    
    // Determine user's fitness level
    let fitnessLevel = 'intermediate';
    if (goals.includes('general_health') && jobType === 'sedentary') {
        fitnessLevel = 'beginner';
    } else if (goals.includes('sports_performance') || jobType === 'very_active') {
        fitnessLevel = 'advanced';
    }
    
    // Enhanced exercise libraries with progression levels
    const exercises = {
        bodyweight: {
            upper_beginner: [
                { name: "Wall Push-ups", sets: 2, reps: "8-12", rest: "45 seconds", notes: "Perfect starting point" },
                { name: "Incline Push-ups", sets: 2, reps: "6-10", rest: "60 seconds", notes: "Use stairs or couch" },
                { name: "Arm Circles", sets: 2, reps: "10 each direction", rest: "30 seconds", notes: "Shoulder warm-up" },
                { name: "Modified Plank", sets: 2, reps: "15-30 seconds", rest: "45 seconds", notes: "On knees if needed" },
                { name: "Standing Side Bends", sets: 2, reps: "10 each side", rest: "30 seconds", notes: "Core activation" }
            ],
            upper_intermediate: [
                { name: "Push-ups", sets: 3, reps: "10-15", rest: "60 seconds", notes: "Keep body straight" },
                { name: "Pike Push-ups", sets: 3, reps: "6-10", rest: "60 seconds", notes: "Great for shoulders" },
                { name: "Tricep Dips", sets: 3, reps: "8-12", rest: "60 seconds", notes: "Use chair or bench" },
                { name: "Plank", sets: 3, reps: "30-60 seconds", rest: "60 seconds", notes: "Core strength builder" },
                { name: "Superman", sets: 3, reps: "10-15", rest: "45 seconds", notes: "Strengthen your back" }
            ],
            upper_advanced: [
                { name: "Diamond Push-ups", sets: 3, reps: "8-12", rest: "75 seconds", notes: "Tricep focused" },
                { name: "Handstand Push-ups (Wall)", sets: 3, reps: "3-8", rest: "90 seconds", notes: "Advanced shoulder work" },
                { name: "Archer Push-ups", sets: 3, reps: "5-8 each side", rest: "90 seconds", notes: "Unilateral strength" },
                { name: "Plank to Push-up", sets: 3, reps: "8-12", rest: "75 seconds", notes: "Dynamic core" },
                { name: "Pseudo Planche Push-ups", sets: 3, reps: "5-10", rest: "90 seconds", notes: "Elite level" }
            ],
            lower_beginner: [
                { name: "Chair Squats", sets: 2, reps: "8-12", rest: "45 seconds", notes: "Use chair for support" },
                { name: "Standing Calf Raises", sets: 2, reps: "12-15", rest: "30 seconds", notes: "Hold wall if needed" },
                { name: "Wall Sit", sets: 2, reps: "15-30 seconds", rest: "60 seconds", notes: "Build leg endurance" },
                { name: "Glute Bridges", sets: 2, reps: "10-15", rest: "45 seconds", notes: "Activate glutes" },
                { name: "Standing Hip Circles", sets: 2, reps: "8 each direction", rest: "30 seconds", notes: "Hip mobility" }
            ],
            lower_intermediate: [
                { name: "Squats", sets: 3, reps: "12-20", rest: "60 seconds", notes: "Go low, stay controlled" },
                { name: "Lunges", sets: 3, reps: "10 each leg", rest: "60 seconds", notes: "Step back or forward" },
                { name: "Single-leg Glute Bridges", sets: 3, reps: "10 each leg", rest: "60 seconds", notes: "Squeeze at the top" },
                { name: "Calf Raises", sets: 3, reps: "15-20", rest: "45 seconds", notes: "Full range of motion" },
                { name: "Step-ups", sets: 3, reps: "10 each leg", rest: "60 seconds", notes: "Use stairs or sturdy box" }
            ],
            lower_advanced: [
                { name: "Jump Squats", sets: 3, reps: "10-15", rest: "75 seconds", notes: "Land softly" },
                { name: "Bulgarian Split Squats", sets: 3, reps: "8-12 each leg", rest: "90 seconds", notes: "Rear foot elevated" },
                { name: "Single-leg Deadlifts", sets: 3, reps: "8-12 each leg", rest: "75 seconds", notes: "Balance challenge" },
                { name: "Pistol Squat Progression", sets: 3, reps: "3-8 each leg", rest: "90 seconds", notes: "Use assistance if needed" },
                { name: "Shrimp Squats", sets: 3, reps: "3-6 each leg", rest: "90 seconds", notes: "Elite movement" }
            ],
            cardio: [
                { name: "Jumping Jacks", sets: 3, reps: "30-45 seconds", rest: "30 seconds", notes: "Classic cardio" },
                { name: "Mountain Climbers", sets: 3, reps: "20-30 each leg", rest: "45 seconds", notes: "Keep hips level" },
                { name: "Burpees", sets: 3, reps: "5-12", rest: "90 seconds", notes: "Modify as needed" },
                { name: "High Knees", sets: 3, reps: "30-45 seconds", rest: "30 seconds", notes: "Quick feet movement" },
                { name: "Squat Jumps", sets: 3, reps: "8-15", rest: "60 seconds", notes: "Explosive power" }
            ],
            mobility: [
                { name: "Cat-Cow Stretch", sets: 2, reps: "10-15 reps", rest: "30 seconds", notes: "Spine mobility" },
                { name: "Hip Circles", sets: 2, reps: "8 each direction", rest: "30 seconds", notes: "Loosen tight hips" },
                { name: "Shoulder Rolls", sets: 2, reps: "10 each direction", rest: "30 seconds", notes: "Perfect for desk workers" },
                { name: "Leg Swings", sets: 2, reps: "10 each leg", rest: "30 seconds", notes: "Dynamic hip stretch" },
                { name: "Arm Crossovers", sets: 2, reps: "10 each arm", rest: "30 seconds", notes: "Shoulder flexibility" }
            ]
        },
        full_gym: {
            upper: [
                { name: "Bench Press", sets: 3, reps: "8-12", rest: "2-3 minutes", notes: "Chest compound movement" },
                { name: "Lat Pulldowns", sets: 3, reps: "10-15", rest: "90 seconds", notes: "Pull to upper chest" },
                { name: "Overhead Press", sets: 3, reps: "8-12", rest: "2 minutes", notes: "Standing if possible" },
                { name: "Barbell Rows", sets: 3, reps: "8-12", rest: "90 seconds", notes: "Squeeze shoulder blades" },
                { name: "Dumbbell Bicep Curls", sets: 3, reps: "12-15", rest: "60 seconds", notes: "Control the negative" },
                { name: "Tricep Rope Pushdowns", sets: 3, reps: "12-15", rest: "60 seconds", notes: "Full extension" }
            ],
            lower: [
                { name: "Barbell Squats", sets: 4, reps: "6-10", rest: "3 minutes", notes: "King of exercises" },
                { name: "Romanian Deadlifts", sets: 3, reps: "8-12", rest: "2-3 minutes", notes: "Hip hinge pattern" },
                { name: "Leg Press", sets: 3, reps: "12-15", rest: "90 seconds", notes: "Deep range of motion" },
                { name: "Walking Lunges", sets: 3, reps: "12 each leg", rest: "90 seconds", notes: "Control the movement" },
                { name: "Leg Curls", sets: 3, reps: "12-15", rest: "60 seconds", notes: "Hamstring isolation" },
                { name: "Calf Raises", sets: 4, reps: "15-20", rest: "45 seconds", notes: "Pause at the top" }
            ],
            cardio: [
                { name: "Treadmill Intervals", sets: 1, reps: "20-30 minutes", rest: "N/A", notes: "Alternate fast/moderate pace" },
                { name: "Rowing Machine", sets: 5, reps: "3 minutes", rest: "90 seconds", notes: "Focus on form over speed" },
                { name: "Stationary Bike HIIT", sets: 8, reps: "30s high / 90s low", rest: "N/A", notes: "Push hard on intervals" },
                { name: "Elliptical Steady State", sets: 1, reps: "25-40 minutes", rest: "N/A", notes: "Moderate intensity" }
            ]
        },
        custom: [
            { name: "Resistance Band Rows", sets: 3, reps: "12-15", rest: "60 seconds", notes: "Anchor band securely" },
            { name: "Dumbbell Squats", sets: 3, reps: "10-15", rest: "75 seconds", notes: "Hold weights at shoulders" },
            { name: "Resistance Band Chest Press", sets: 3, reps: "12-15", rest: "60 seconds", notes: "Control the resistance" },
            { name: "Dumbbell Deadlifts", sets: 3, reps: "8-12", rest: "90 seconds", notes: "Keep back straight" },
            { name: "Band Pull-Aparts", sets: 3, reps: "15-20", rest: "45 seconds", notes: "Great for posture" },
            { name: "Dumbbell Shoulder Press", sets: 3, reps: "10-15", rest: "75 seconds", notes: "Press overhead" }
        ]
    };
    
    // Choose appropriate exercise library based on equipment
    let exerciseLibrary;
    if (equipment === 'full_gym') {
        exerciseLibrary = exercises.full_gym;
    } else if (equipment === 'custom') {
        exerciseLibrary = { mixed: exercises.custom, mobility: exercises.bodyweight.mobility };
    } else {
        exerciseLibrary = exercises.bodyweight;
    }
    
    // Generate workouts for each training day
    trainingDays.forEach((day, index) => {
        let dayExercises = [];
        
        if (equipment === 'bodyweight') {
            // Smart workout rotation for bodyweight training
            if (index % 3 === 0) {
                // Upper body focus
                dayExercises = [...(exerciseLibrary[`upper_${fitnessLevel}`] || exerciseLibrary.upper_intermediate)];
                
                // Add cardio for weight loss goals
                if (goals.includes('lose_weight') || isOverweight) {
                    dayExercises.push(...exerciseLibrary.cardio.slice(0, 2));
                }
                
                // Add mobility for desk workers
                if (jobType === 'sedentary') {
                    dayExercises.push(...exerciseLibrary.mobility.slice(0, 2));
                }
            } else if (index % 3 === 1) {
                // Lower body focus
                dayExercises = [...(exerciseLibrary[`lower_${fitnessLevel}`] || exerciseLibrary.lower_intermediate)];
                
                // Add different cardio exercises
                if (goals.includes('lose_weight') || goals.includes('build_endurance')) {
                    dayExercises.push(...exerciseLibrary.cardio.slice(2, 4));
                }
                
                // Add hip mobility for everyone
                dayExercises.push(...exerciseLibrary.mobility.filter(ex => ex.name.includes('Hip')));
            } else {
                // Full body or active recovery
                dayExercises = [
                    ...(exerciseLibrary[`upper_${fitnessLevel}`] || exerciseLibrary.upper_intermediate).slice(0, 2),
                    ...(exerciseLibrary[`lower_${fitnessLevel}`] || exerciseLibrary.lower_intermediate).slice(0, 2)
                ];
                
                // Always include mobility on full body days
                dayExercises.push(...exerciseLibrary.mobility.slice(0, 3));
                
                // Add light cardio
                if (goals.includes('build_endurance') || goals.includes('general_health')) {
                    dayExercises.push(exerciseLibrary.cardio[0]); // Jumping jacks
                }
            }
        } else if (equipment === 'full_gym') {
            // Traditional gym split
            if (index % 3 === 0) {
                // Upper body
                dayExercises = [...exerciseLibrary.upper];
            } else if (index % 3 === 1) {
                // Lower body
                dayExercises = [...exerciseLibrary.lower];
            } else {
                // Cardio/conditioning day
                dayExercises = [
                    ...exerciseLibrary.upper.slice(0, 3),
                    ...exerciseLibrary.lower.slice(0, 2),
                    ...exerciseLibrary.cardio.slice(0, 1)
                ];
            }
        } else {
            // Custom equipment - mixed approach
            dayExercises = [...exerciseLibrary.mixed];
            if (index % 2 === 0) {
                dayExercises.push(...exerciseLibrary.mobility.slice(0, 2));
            }
        }
        
        // Adjust workout length based on available time
        if (sessionTime <= 20) {
            dayExercises = dayExercises.slice(0, 4);
        } else if (sessionTime <= 30) {
            dayExercises = dayExercises.slice(0, 5);
        } else if (sessionTime <= 45) {
            dayExercises = dayExercises.slice(0, 7);
        } else if (sessionTime <= 60) {
            dayExercises = dayExercises.slice(0, 8);
        } else {
            // 90+ minutes - keep all exercises
        }
        
        // Ensure minimum workout length
        if (dayExercises.length < 3) {
            dayExercises = [...dayExercises, ...exerciseLibrary[Object.keys(exerciseLibrary)[0]].slice(0, 3)];
        }
        
        workoutPlan.weekly_schedule[day] = {
            exercises: dayExercises
        };
    });
    
    return workoutPlan;
}

        // Chat functions
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessageToChat('user', message);
            input.value = '';

            try {
                const prompt = `You are Flexi, a helpful AI fitness assistant. The user's current workout plan is:
${currentWorkoutPlan ? JSON.stringify(currentWorkoutPlan.plan_data, null, 2) : 'No workout plan generated yet'}

User profile:
${userProfile ? JSON.stringify(userProfile, null, 2) : 'No profile data'}

User preferences:
${userPreferences ? JSON.stringify(userPreferences, null, 2) : 'No preferences set'}

User message: ${message}

Please provide helpful, encouraging, and specific fitness advice. If they want to modify their workout, suggest specific changes. Keep responses conversational and supportive.`;

                const response = await fetch('/.netlify/functions/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        user_id: currentUser.id
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response from Flexi');
                }

                const data = await response.json();
                addMessageToChat('bot', data.content);
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessageToChat('bot', 'Sorry, I\'m having trouble responding right now. Please try again!');
            }
        }

        function addMessageToChat(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `<strong>Flexi:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // UI functions
        function showApp() {
            document.getElementById('auth-section').classList.remove('active');
            document.getElementById('navigation').style.display = 'block';
            showSection('profile');
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            if (sectionName === 'auth-section') {
                document.getElementById('auth-section').classList.add('active');
            } else {
                document.getElementById(sectionName + '-section').classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the correct nav button
            const targetBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.textContent.toLowerCase().includes(sectionName.split('-')[0])
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        function populateProfileForm() {
            if (!userProfile) return;
            
            document.getElementById('userName').value = userProfile.name || '';
            document.getElementById('userJob').value = userProfile.job_type || '';
            document.getElementById('userHeight').value = userProfile.height || '';
            document.getElementById('userWeight').value = userProfile.weight || '';
            document.getElementById('userCondition').value = userProfile.physical_condition || '';
        }

        function populatePreferencesForm() {
            if (!userPreferences) return;
            
            document.getElementById('sessionTime').value = userPreferences.session_time || '';
            
            // Fitness goals
            if (userPreferences.fitness_goals) {
                userPreferences.fitness_goals.forEach(goal => {
                    const card = document.querySelector(`[data-goal="${goal}"]`);
                    if (card) card.classList.add('selected');
                });
            }
            
            // Training days
            if (userPreferences.training_days) {
                userPreferences.training_days.forEach(day => {
                    const checkbox = document.getElementById(day);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Equipment
            if (userPreferences.available_equipment && userPreferences.available_equipment.length > 0) {
                const equipment = userPreferences.available_equipment[0];
                const card = document.querySelector(`[data-equipment="${equipment}"]`);
                if (card) {
                    card.classList.add('selected');
                    if (equipment === 'custom') {
                        document.getElementById('customEquipment').classList.add('active');
                        document.getElementById('customEquipmentText').value = userPreferences.custom_equipment || '';
                    }
                }
            }
        }

        function displayWorkoutPlan(planData) {
            const container = document.getElementById('workoutPlan');
            
            if (!planData || !planData.weekly_schedule) {
                container.innerHTML = '<p>No workout plan available. Generate one to get started!</p>';
                return;
            }

            let html = `<div class="plan-overview">
                <h3>Plan Overview</h3>
                <p>${planData.plan_overview || 'Your personalized workout plan'}</p>
            </div>`;

            Object.entries(planData.weekly_schedule).forEach(([day, dayData]) => {
                html += `
                    <div class="day-section">
                        <div class="day-title">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                        <table class="exercise-table">
                            <thead>
                                <tr>
                                    <th>Exercise</th>
                                    <th>Sets</th>
                                    <th>Reps</th>
                                    <th>Rest</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                if (dayData.exercises) {
                    dayData.exercises.forEach(exercise => {
                        html += `
                            <tr>
                                <td><span class="exercise-name" onclick="searchExercise('${exercise.name}')">${exercise.name}</span></td>
                                <td>${exercise.sets || '-'}</td>
                                <td>${exercise.reps || '-'}</td>
                                <td>${exercise.rest || '-'}</td>
                                <td>${exercise.notes || '-'}</td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function searchExercise(exerciseName) {
            const searchUrl = `https://www.youtube.com/results?search_query=How+to+do+${encodeURIComponent(exerciseName)}`;
            window.open(searchUrl, '_blank');
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>