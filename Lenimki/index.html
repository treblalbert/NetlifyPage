<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LENIMKI | Management Portal</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --weapon-red: #dc2626;
            --food-green: #16a34a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }

        .search-bar { 
            margin-bottom: 20px; padding: 12px; border: 1px solid var(--border); 
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
            background: white;
        }
        
        .search-bar input { border: none; outline: none; width: 100%; font-size: 1rem; }

        input, select, button { 
            padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; 
            font-family: inherit;
        }

        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-save-pi { background: #16a34a; color: white; padding: 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 8px; }
        .btn-export { background: #0f172a; color: white; padding: 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 8px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }

        .editable:hover { background: #eff6ff; cursor: text; outline: 1px dashed var(--primary); }

        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .tag-yes { background: #dcfce7; color: #166534; }
        .tag-no { background: #fee2e2; color: #991b1b; }

        .expandable { cursor: pointer; }
        .details-panel { background: #fafafa !important; padding: 0; border-bottom: 2px solid var(--border); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
        .stat-val { font-weight: bold; font-size: 0.95rem; font-family: monospace; }
        .val-weapon { color: var(--weapon-red); }
        .val-food { color: var(--food-green); }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .key-row { display: flex; align-items: center; margin-bottom: 15px; }
        .key-cap { 
            background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; 
            padding: 6px 12px; min-width: 50px; text-align: center; font-weight: 700; 
            box-shadow: 0 3px 0 #94a3b8; margin-right: 15px; font-family: monospace;
        }
        .status-msg { margin-top: 15px; font-size: 0.85rem; color: var(--text-muted); font-family: monospace; padding: 10px; background: #f8fafc; border-radius: 6px; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab(event, 'database')">Database Management</button>
        <button class="tab-btn" onclick="openTab(event, 'controls')">Game Controls</button>
    </div>

    <div id="database" class="tab-content active">
        <h1 style="font-size: 1.25rem; margin-bottom: 5px;">LENIMKI Database Portal</h1>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">Click on Name, Weight, or Price cells to edit values locally.</p>
        
        <div class="search-bar">
            <span style="color: var(--text-muted)">SEARCH:</span>
            <input type="text" id="searchInput" placeholder="Search by name or type..." onkeyup="renderTable()">
        </div>

        <table id="itemTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Weight</th>
                    <th>Price (Larks)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div id="status" class="status-msg">System: Initializing...</div>

        <div class="action-buttons">
            <button class="btn-save-pi" onclick="saveToPi()">‚òÅÔ∏è SAVE TO RASPBERRY PI</button>
            <button class="btn-export" onclick="downloadJSON()">üíæ EXPORT BACKUP (JSON)</button>
        </div>
    </div>

    <div id="controls" class="tab-content">
        <h1 style="font-size: 1.25rem; margin-bottom: 20px;">Reference: Player Controls</h1>
        <div class="controls-grid">
            <div>
                <h2 style="color:var(--primary); font-size: 0.9rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 20px; text-transform: uppercase;">Movement</h2>
                <div class="key-row"><div class="key-cap">WASD</div><div class="key-desc">Movement</div></div>
                <div class="key-row"><div class="key-cap">SHIFT</div><div class="key-desc">Run / Sprint</div></div>
            </div>
            <div>
                <h2 style="color:var(--primary); font-size: 0.9rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 20px; text-transform: uppercase;">Combat & UI</h2>
                <div class="key-row"><div class="key-cap">TAB</div><div class="key-desc">Inventory</div></div>
            </div>
        </div>
    </div>
</div>

<script>
    const PI_URL = 'http://192.168.1.222:3000';
    let items = [];

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) tabcontent[i].classList.remove("active");
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) tablinks[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    async function loadData() {
        const status = document.getElementById('status');
        try {
            // Fetch directly from our new Node server
            const response = await fetch(`${PI_URL}/items.json`);
            items = await response.json();
            status.innerText = "System: Connected to Raspberry Pi. Data loaded.";
            renderTable();
        } catch (err) {
            status.innerHTML = "<span style='color:red'>Error: Could not connect to Pi server at " + PI_URL + "</span>";
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const filter = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        
        items.sort((a, b) => a.id - b.id);
        
        items.forEach((item) => {
            if (!item.name.toLowerCase().includes(filter) && !item.type.toLowerCase().includes(filter)) return;

            const isWeapon = item.type === 'Weapon' && item.stats;
            const isFood = item.type === 'Food' && item.consumable;
            
            const tr = document.createElement('tr');
            const statusLabel = item.implemented ? '<span class="status-tag tag-yes">Implemented</span>' : '<span class="status-tag tag-no">Pending</span>';

            tr.innerHTML = `
                <td><strong>${item.id}</strong></td>
                <td class="editable" contenteditable="true" onblur="updateData(${item.id}, 'name', this.innerText)">${item.name}</td>
                <td><span style="color: ${getTypeColor(item.type)}; font-weight: 600;">${item.type}</span></td>
                <td class="editable" contenteditable="true" onblur="updateData(${item.id}, 'weight', this.innerText)">${item.weight || '0.00KG'}</td>
                <td class="editable" style="color:#b45309; font-weight: 500;" contenteditable="true" onblur="updateData(${item.id}, 'price', this.innerText)">${item.price || 0}</td>
                <td onclick="toggleImplemented(${item.id})" style="cursor:pointer">${statusLabel}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Logic to update local array when user edits a cell
    function updateData(id, field, value) {
        const item = items.find(i => i.id === id);
        if (item) {
            if (field === 'price') {
                item[field] = parseInt(value.replace(/[^0-9]/g, '')) || 0;
            } else {
                item[field] = value;
            }
            console.log(`Updated local data for ID ${id}`);
        }
    }

    function toggleImplemented(id) {
        const item = items.find(i => i.id === id);
        if (item) {
            item.implemented = !item.implemented;
            renderTable();
        }
    }

    async function saveToPi() {
        const status = document.getElementById('status');
        status.innerText = "System: Sending data to Raspberry Pi...";
        
        try {
            const response = await fetch(`${PI_URL}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items)
            });
            
            if (response.ok) {
                status.innerHTML = "<span style='color:green'>System: SUCCESSFULLY SAVED TO PI.</span>";
            } else {
                throw new Error("Server rejected save");
            }
        } catch (err) {
            status.innerHTML = "<span style='color:red'>Error: Failed to save. Is server.js running?</span>";
        }
    }

    function getTypeColor(type) {
        switch(type) {
            case 'Weapon': return '#dc2626';
            case 'Food': return '#16a34a';
            case 'Ammo': return '#ca8a04';
            case 'Misc': return '#2563eb';
            default: return '#1e293b';
        }
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "items_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    loadData();
</script>
</body>
</html>